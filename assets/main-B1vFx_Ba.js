(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))a(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const r of s.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&a(r)}).observe(document,{childList:!0,subtree:!0});function i(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function a(n){if(n.ep)return;n.ep=!0;const s=i(n);fetch(n.href,s)}})();Array.prototype.deleteFirst=function(t){for(var e=0;e<this.length;e++)if(this[e]==t)return this.splice(e,1),!0;return!1};Array.prototype.stableSort=function(t){for(var e=0;e<this.length;e++)this[e].__arrayPos=e;return this.sort(Array.__stableSorter(t))};Array.__stableSorter=function(t){return function(e,i){var a=t(e,i);return a||e.__arrayPos-i.__arrayPos}};Array.prototype.equals=function(t){if(!t||this.length!=t.length)return!1;for(var e=0;e<this.length;e++){var i=this[e],a=t[e];if(i.equals&&typeof i.equals=="function"){if(!i.equals(a))return!1}else if(i!=a)return!1}return!0};Array.prototype.rotate=function(t){return t?(this.unshift(this.pop()),this[0]):(this.push(this.shift()),this[this.length-1])};Array.prototype.pick=function(){return this[Math.floor(Math.random()*this.length)]};Array.prototype.flatten=function(){for(var t=[],e=0;e<this.length;e++){var i=this[e];if(i.flatten)for(var a=i.flatten(),n=0;n<a.length;n++)t[t.length]=a[n];else t[t.length]=i}return t};Array.prototype.take=function(){for(var t=[],e=0;e<this.length;e++){for(var i=[],a=0;a<arguments.length;a++)i[a]=this[e][arguments[a]];t[e]=i}return t};Array.prototype.pluck||(Array.prototype.pluck=function(t){for(var e=[],i=0;i<this.length;i++)e[i]=this[i][t];return e});Array.prototype.set=function(t,e){for(var i=0;i<this.length;i++)this[i][t]=e};Array.prototype.allWith=function(){var t=[];t:for(var e=0;e<this.length;e++){for(var i=this[e],a=0;a<arguments.length;a++)if(!this[e][arguments[a]])continue t;t[t.length]=i}return t};Array.prototype.last||(Array.prototype.last=function(){return this[this.length-1]});Object.forceExtend=function(t,e){for(var i in e)try{t[i]=e[i]}catch{}return t};Object.extend||(Object.extend=Object.forceExtend);Object.conditionalExtend=function(t,e){for(var i in e)t[i]==null&&(t[i]=e[i]);return t};Object.clone=function(src){if(!src||src==!0)return src;switch(typeof src){case"string":return Object.extend(src+"",src);case"number":return src;case"function":return obj=eval(src.toSource()),Object.extend(obj,src);case"object":return src instanceof Array?Object.extend([],src):Object.extend({},src)}};Object.loadImage=function(t,e){var i=new Image;return e&&(i.onload=e),i.src=t,i};Object.isImageLoaded=function(t){return t.tagName=="CANVAS"?!0:t.complete?t.naturalWidth==null?!0:!!t.naturalWidth:!1};Object.sum=function(t,e){if(t instanceof Array)if(e instanceof Array){for(var i=[],a=0;a<t.length;a++)i[a]=t[a]+e[a];return i}else return t.map(function(n){return n+e});else return e instanceof Array?e.map(function(n){return n+t}):t+e};Object.sub=function(t,e){if(t instanceof Array)if(e instanceof Array){for(var i=[],a=0;a<t.length;a++)i[a]=t[a]-e[a];return i}else return t.map(function(n){return n-e});else return e instanceof Array?e.map(function(n){return t-n}):t-e};String.prototype.capitalize||(String.prototype.capitalize=function(){return this.replace(/^./,this.slice(0,1).toUpperCase())});String.prototype.escape||(String.prototype.escape=function(){return'"'+this.replace(/"/g,'\\"')+'"'});String.prototype.splice||(String.prototype.splice=function(t,e,i){return this.slice(0,t)+i+this.slice(t+e)});String.prototype.strip||(String.prototype.strip=function(){return this.replace(/^\s+|\s+$/g,"")});window.$A||(window.$A=function(t){for(var e=new Array(t.length),i=0;i<t.length;i++)e[i]=t[i];return e});window.$||(window.$=function(t){return document.getElementById(t)});window.Klass=function(){var t=function(){this.initialize.apply(this,arguments)};t.ancestors=$A(arguments),t.prototype={};for(var e=0;e<arguments.length;e++){var i=arguments[e];i.prototype?Object.extend(t.prototype,i.prototype):Object.extend(t.prototype,i)}return Object.extend(t,t.prototype),t};window.E=function(t,e,i){var a=document.createElement(t);if(e&&(typeof e=="string"?(a.innerHTML=e,e=i):e.DOCUMENT_NODE&&(a.appendChild(e),e=i),e)){if(e.style){var n=e.style;e=Object.clone(e),delete e.style,Object.forceExtend(a.style,n)}e.content&&(typeof e.content=="string"?a.appendChild(T(e.content)):a.appendChild(e.content),e=Object.clone(e),delete e.content),Object.forceExtend(a,e)}return a};E.lastCanvasId=0;E.canvas=function(t,e,i){var a="canvas-uuid-"+E.lastCanvasId;return E.lastCanvasId++,i||(i={}),E("canvas",Object.extend(i,{id:a,width:t,height:e}))};window.T=function(t){return document.createTextNode(t)};window.Mouse||(window.Mouse={});Mouse.getRelativeCoords=function(t,e){var i={x:0,y:0};const a=t.getBoundingClientRect();return i.x=e.clientX-a.left,i.y=e.clientY-a.top,i};Mouse.LEFT=0;Mouse.MIDDLE=1;Mouse.RIGHT=2;window.Curves={angularDistance:function(t,e){var i=Math.PI*2,a=(e-t)%i;return a>Math.PI&&(a-=i),a<-Math.PI&&(a+=i),a},linePoint:function(t,e,i){return[t[0]+(e[0]-t[0])*i,t[1]+(e[1]-t[1])*i]},quadraticPoint:function(t,e,i,a){var n=t[0]+(e[0]-t[0])*a,s=e[0]+(i[0]-e[0])*a,r=n+(s-n)*a,h=t[1]+(e[1]-t[1])*a,o=e[1]+(i[1]-e[1])*a,l=h+(o-h)*a;return[r,l]},cubicPoint:function(t,e,i,a,n){var s=t[0]*3,r=e[0]*3,h=i[0]*3,o=t[1]*3,l=e[1]*3,f=i[1]*3;return[t[0]+n*(r-s+n*(s-2*r+h+n*(r-t[0]-h+a[0]))),t[1]+n*(l-o+n*(o-2*l+f+n*(l-t[1]-f+a[1])))]},linearValue:function(t,e,i){return t+(e-t)*i},quadraticValue:function(t,e,i,a){var n=t+(e-t)*a,s=e+(i-e)*a;return n+(s-n)*a},cubicValue:function(t,e,i,a,n){var s=t*3,r=e*3,h=i*3;return t+n*(r-s+n*(s-2*r+h+n*(r-t-h+a)))},catmullRomPoint:function(t,e,i,a,n){var s=((-n+2)*n-1)*n*.5,r=((3*n-5)*n*n+2)*.5,h=((-3*n+4)*n+1)*n*.5,o=(n-1)*n*n*.5;return[t[0]*s+e[0]*r+i[0]*h+a[0]*o,t[1]*s+e[1]*r+i[1]*h+a[1]*o]},catmullRomAngle:function(t,e,i,a,n){var s=.5*(i[0]-t[0]+2*n*(2*t[0]-5*e[0]+4*i[0]-a[0])+3*n*n*(3*e[0]+a[0]-t[0]-3*i[0])),r=.5*(i[1]-t[1]+2*n*(2*t[1]-5*e[1]+4*i[1]-a[1])+3*n*n*(3*e[1]+a[1]-t[1]-3*i[1]));return Math.atan2(r,s)},catmullRomPointAngle:function(r,e,i,a,n){var s=this.catmullRomPoint(r,e,i,a,n),r=this.catmullRomAngle(r,e,i,a,n);return{point:s,angle:r}},lineAngle:function(t,e){return Math.atan2(e[1]-t[1],e[0]-t[0])},quadraticAngle:function(t,e,i,a){var n=this.linePoint(t,e,a),s=this.linePoint(e,i,a);return this.lineAngle(n,s)},cubicAngle:function(t,e,i,a,n){var s=this.quadraticPoint(t,e,i,n),r=this.quadraticPoint(e,i,a,n);return this.lineAngle(s,r)},lineLength:function(t,e){var i=e[0]-t[0],a=e[1]-t[1];return Math.sqrt(i*i+a*a)},squareLineLength:function(t,e){var i=e[0]-t[0],a=e[1]-t[1];return i*i+a*a},quadraticLength:function(t,e,i,a){var n=this.linePoint(t,e,.6666666666666666),s=this.linePoint(e,i,1/3);return this.cubicLength(t,n,s,i,a)},cubicLength:function(){var t=function(i){for(var a=[i.slice(0)],n=1;n<4;n++){a[n]=[[],[],[],[]];for(var s=0;s<4-n;s++)a[n][s][0]=.5*(a[n-1][s][0]+a[n-1][s+1][0]),a[n][s][1]=.5*(a[n-1][s][1]+a[n-1][s+1][1])}for(var r=[],h=[],s=0;s<4;s++)r[s]=a[s][0],h[s]=a[3-s][s];return[r,h]},e=function(i,a){for(var n=0,s=0;s<3;s++)n+=Curves.lineLength(i[s],i[s+1]);var r=Curves.lineLength(i[0],i[3]);if(n-r>a){var h=t(i);n=e(h[0],a)+e(h[1],a)}return n};return function(i,a,n,s,r){return r||(r=1),e([i,a,n,s],r)}}(),quadraticLengthPointAngle:function(t,e,i,a,n){var s=this.linePoint(t,e,.6666666666666666),r=this.linePoint(e,i,1/3);return this.cubicLengthPointAngle(t,s,r,i,n)},cubicLengthPointAngle:function(t,e,i,a,n,s){for(var r=this.cubicLength(t,e,i,a,s),h=t,o=t,l=0,f=0,u=n*r,c=20,d=1/c,g=1;g<=c;g++)if(o=h,h=this.cubicPoint(t,e,i,a,d*g),l=f,f+=this.lineLength(o,h),f>=u){if(f==l)return{point:h,angle:this.lineAngle(t,e)};var m=f-u,p=m/(f-l);return{point:this.linePoint(o,h,1-p),angle:this.cubicAngle(t,e,i,a,d*(g-p))}}return{point:a.slice(0),angle:this.lineAngle(i,a)}}};window.Colors={hsl2rgb:function(t,e,i){var a,n,s;if(e==0)a=n=s=v;else{var r=i<.5?i*(1+e):i+e-i*e,h=2*i-r,o=t%360/360,l=o+1/3,f=o,u=o-1/3;l<0&&l++,l>1&&l--,f<0&&f++,f>1&&f--,u<0&&u++,u>1&&u--,l<1/6?a=h+(r-h)*6*l:l<1/2?a=r:l<2/3?a=h+(r-h)*6*(2/3-l):a=h,f<1/6?n=h+(r-h)*6*f:f<1/2?n=r:f<2/3?n=h+(r-h)*6*(2/3-f):n=h,u<1/6?s=h+(r-h)*6*u:u<1/2?s=r:u<2/3?s=h+(r-h)*6*(2/3-u):s=h}return[a,n,s]},hsv2rgb:function(t,e,i){var a,n,s;if(e==0)a=n=s=i;else{t=t%360/60;var r=Math.floor(t),h=t-r,o=i*(1-e),l=i*(1-e*h),f=i*(1-e*(1-h));switch(r){case 0:a=i,n=f,s=o;break;case 1:a=l,n=i,s=o;break;case 2:a=o,n=i,s=f;break;case 3:a=o,n=l,s=i;break;case 4:a=f,n=o,s=i;break;case 5:a=i,n=o,s=l;break}}return[a,n,s]},parseColorStyle:function(t,e){if(typeof t=="string")return t;if(t.compiled)return t.compiled;if(t.isPattern)return t.compile(e);if(t.length==3)return"rgba("+t.map(Math.round).join(",")+", 1)";if(t.length==4)return"rgba("+Math.round(t[0])+","+Math.round(t[1])+","+Math.round(t[2])+","+t[3]+")";throw"Bad style: "+t}};window.CanvasSupport={DEVICE_SPACE:0,USER_SPACE:1,isPointInPathMode:null,supportsIsPointInPath:null,supportsCSSTransform:null,supportsCanvas:null,isCanvasSupported:function(){if(this.supportsCanvas==null){var t={};try{t=E("canvas")}catch{}this.supportsCanvas=t.getContext!=null}return this.supportsCanvas},isCSSTransformSupported:function(){if(this.supportsCSSTransform==null){var t=E("div"),e=t.style,i=e.webkitTransform!=null||e.MozTransform!=null;this.supportsCSSTransform=i!=null}return this.supportsCSSTransform},getTestContext:function(){if(!this.testContext){var t=E.canvas(1,1);this.testContext=t.getContext("2d")}return this.testContext},getSupportsAudioTag:function(){var t=E("audio");return!!t.play},getSupportsSoundManager:function(){return window.soundManager&&soundManager.enabled},soundId:0,getSoundObject:function(){var t=null;return this.getSupportsSoundManager()&&(t=this.getSoundManagerSoundObject()),t},getAudioTagSoundObject:function(){var t="sound-"+this.soundId++,e=E("audio",{id:t});return e.load=function(i){this.src=i},e.addEventListener("canplaythrough",function(){this.onready&&this.onready()},!1),e.setVolume=function(i){this.volume=i},e.setPan=function(i){this.pan=i},e},getSoundManagerSoundObject:function(){var t="sound-"+this.soundId++,e={volume:100,pan:0,sid:t,load:function(i){return soundManager.load(this.sid,{url:i,autoPlay:!1,volume:this.volume,pan:this.pan})},_onload:function(){this.onload&&this.onload(),this.onready&&this.onready()},_onerror:function(){this.onerror&&this.onerror()},_onfinish:function(){this.onfinish&&this.onfinish()},play:function(){return soundManager.play(this.sid)},stop:function(){return soundManager.stop(this.sid)},pause:function(){return soundManager.togglePause(this.sid)},setVolume:function(i){return this.volume=i*100,soundManager.setVolume(this.sid,i*100)},setPan:function(i){return this.pan=i*100,soundManager.setPan(this.sid,i*100)}};return soundManager.createSound(t,"null.mp3"),e.sound=soundManager.getSoundById(t),e.sound.options.onfinish=e._onfinish.bind(e),e.sound.options.onload=e._onload.bind(e),e.sound.options.onerror=e._onerror.bind(e),e},ContextSetterAugment:{setFillStyle:function(t){this.fillStyle=t},setStrokeStyle:function(t){this.strokeStyle=t},setGlobalAlpha:function(t){this.globalAlpha=t},setLineWidth:function(t){this.lineWidth=t},setLineCap:function(t){this.lineCap=t},setLineJoin:function(t){this.lineJoin=t},setMiterLimit:function(t){this.miterLimit=t},setGlobalCompositeOperation:function(t){this.globalCompositeOperation=t},setShadowColor:function(t){this.shadowColor=t},setShadowBlur:function(t){this.shadowBlur=t},setShadowOffsetX:function(t){this.shadowOffsetX=t},setShadowOffsetY:function(t){this.shadowOffsetY=t},setMozTextStyle:function(t){this.mozTextStyle=t},setFont:function(t){this.font=t},setTextAlign:function(t){this.textAlign=t},setTextBaseline:function(t){this.textBaseline=t}},ContextJSImplAugment:{identity:function(){CanvasSupport.setTransform(this,[1,0,0,1,0,0])}},augment:function(t){return Object.conditionalExtend(t,this.ContextSetterAugment),Object.conditionalExtend(t,this.ContextJSImplAugment),t},getContext:function(t,e){var i=t.getContext(e||"2d");return this.augment(i),i},tMatrixMultiply:function(t,e){var i=t[0]*e[0]+t[2]*e[1],a=t[1]*e[0]+t[3]*e[1],n=t[0]*e[2]+t[2]*e[3],s=t[1]*e[2]+t[3]*e[3],r=t[0]*e[4]+t[2]*e[5]+t[4],h=t[1]*e[4]+t[3]*e[5]+t[5];return t[0]=i,t[1]=a,t[2]=n,t[3]=s,t[4]=r,t[5]=h,t},tMatrixMultiplyPoint:function(t,e,i){return[e*t[0]+i*t[2]+t[4],e*t[1]+i*t[3]+t[5]]},tInvertMatrix:function(t){var e=1/(t[0]*t[3]-t[1]*t[2]);return[t[3]*e,-t[1]*e,-t[2]*e,t[0]*e,e*(t[2]*t[5]-t[3]*t[4]),e*(t[1]*t[4]-t[0]*t[5])]},transform:function(t,e){if(t.transform)return t.transform.apply(t,e);if(t.translate(e[4],e[5]),Math.abs(e[1])<1e-6&&Math.abs(e[2])<1e-6){t.scale(e[0],e[3]);return}var i=this.svdTransform({xx:e[0],xy:e[2],yx:e[1],yy:e[3],dx:e[4],dy:e[5]});t.rotate(i.angle2),t.scale(i.sx,i.sy),t.rotate(i.angle1)},brokenSvd:function(t){var e=[t[0],t[2],t[1],t[3],0,0],i=[e[0]*t[0]+e[2]*t[1],e[1]*t[0]+e[3]*t[1],e[0]*t[2]+e[2]*t[3],e[1]*t[2]+e[3]*t[3],0,0],a=1,n=-(i[0]+i[3]),s=-(i[1]*i[2])+i[0]*i[3],r=Math.sqrt(n*n-4*a*s),o=(-n+r)/(2*a),l=(-n-r)/(2*a);if(o<l)var h=o,o=l,l=h;var f=Math.sqrt(o),u=Math.sqrt(l),c=[1/f,0,0,1/u,0,0],d=(i[0]-o)/i[2],g=Math.sqrt(1+d*d),m=1/g,p=d/g,w=m,S=-p,b=[m,S,p,w,0,0],P=t.slice(0);return this.tMatrixMultiply(P,b),this.tMatrixMultiply(P,c),[P,[f,0,0,u,0,0],[m,p,S,w,0,0]]},svdTransform:function(){var t={};t.Matrix2D=function(o){if(o)if(typeof o=="number")this.xx=this.yy=o;else if(o instanceof Array){if(o.length>0){for(var l=t.normalize(o[0]),f=1;f<o.length;++f){var u=l,c=t.normalize(o[f]);l=new t.Matrix2D,l.xx=u.xx*c.xx+u.xy*c.yx,l.xy=u.xx*c.xy+u.xy*c.yy,l.yx=u.yx*c.xx+u.yy*c.yx,l.yy=u.yx*c.xy+u.yy*c.yy,l.dx=u.xx*c.dx+u.xy*c.dy+u.dx,l.dy=u.yx*c.dx+u.yy*c.dy+u.dy}Object.extend(this,l)}}else Object.extend(this,o)},t.normalize=function(o){return o instanceof t.Matrix2D?o:new t.Matrix2D(o)},t.multiply=function(o){for(var l=t.normalize(o),f=1;f<arguments.length;++f){var u=l,c=t.normalize(arguments[f]);l=new t.Matrix2D,l.xx=u.xx*c.xx+u.xy*c.yx,l.xy=u.xx*c.xy+u.xy*c.yy,l.yx=u.yx*c.xx+u.yy*c.yx,l.yy=u.yx*c.xy+u.yy*c.yy,l.dx=u.xx*c.dx+u.xy*c.dy+u.dx,l.dy=u.yx*c.dx+u.yy*c.dy+u.dy}return l},t.invert=function(o){var f=t.normalize(o),l=f.xx*f.yy-f.xy*f.yx,f=new t.Matrix2D({xx:f.yy/l,xy:-f.xy/l,yx:-f.yx/l,yy:f.xx/l,dx:(f.xy*f.dy-f.yy*f.dx)/l,dy:(f.yx*f.dx-f.xx*f.dy)/l});return f},Object.extend(t.Matrix2D,{xx:1,xy:0,yx:0,yy:1,dx:0,dy:0});var e=function(o,l){return Math.abs(o-l)<=1e-6*(Math.abs(o)+Math.abs(l))},i=function(o,l){if(isFinite(o)){if(!isFinite(l))return o}else return l;return(o+l)/2},a=function(o){var l=new t.Matrix2D(o);return Object.extend(l,{dx:0,dy:0,xy:l.yx,yx:l.xy})},n=function(o){return o.xx*o.yy<0||o.xy*o.yx>0?-1:1},s=function(o){var l=t.normalize(o),f=-l.xx-l.yy,u=l.xx*l.yy-l.xy*l.yx,c=Math.sqrt(f*f-4*u),d=-(f+(f<0?-c:c))/2,g=u/d,m=l.xy/(d-l.xx),p=1,w=l.xy/(g-l.xx),S=1;e(d,g)&&(m=1,p=0,w=0,S=1),isFinite(m)||(m=1,p=(d-l.xx)/l.xy,isFinite(p)||(m=(d-l.yy)/l.yx,p=1,isFinite(m)||(m=1,p=l.yx/(d-l.yy)))),isFinite(w)||(w=1,S=(g-l.xx)/l.xy,isFinite(S)||(w=(g-l.yy)/l.yx,S=1,isFinite(w)||(w=1,S=l.yx/(g-l.yy))));var b=Math.sqrt(m*m+p*p),P=Math.sqrt(w*w+S*S);return isNaN(m/=b)&&(m=0),isNaN(p/=b)&&(p=0),isNaN(w/=P)&&(w=0),isNaN(S/=P)&&(S=0),{value1:d,value2:g,vector1:{x:m,y:p},vector2:{x:w,y:S}}},r=function(o,l){var f=n(o),u=l.angle1=(Math.atan2(o.yx,o.yy)+Math.atan2(-f*o.xy,f*o.xx))/2,c=Math.cos(u),d=Math.sin(u);return l.sx=i(o.xx/c,-o.xy/d),l.sy=i(o.yy/c,o.yx/d),l},h=function(o,l){var f=n(o),u=l.angle2=(Math.atan2(f*o.yx,f*o.xx)+Math.atan2(-o.xy,o.yy))/2,c=Math.cos(u),d=Math.sin(u);return l.sx=i(o.xx/c,o.yx/d),l.sy=i(o.yy/c,-o.xy/d),l};return function(o){var l=t.normalize(o),f={dx:l.dx,dy:l.dy,sx:1,sy:1,angle1:0,angle2:0};if(e(l.xy,0)&&e(l.yx,0))return Object.extend(f,{sx:l.xx,sy:l.yy});if(e(l.xx*l.yx,-l.xy*l.yy))return r(l,f);if(e(l.xx*l.xy,-l.yx*l.yy))return h(l,f);var u=a(l),c=s([l,u]),d=s([u,l]),g=new t.Matrix2D({xx:c.vector1.x,xy:c.vector2.x,yx:c.vector1.y,yy:c.vector2.y}),m=new t.Matrix2D({xx:d.vector1.x,xy:d.vector1.y,yx:d.vector2.x,yy:d.vector2.y}),p=new t.Matrix2D([t.invert(g),l,t.invert(m)]);return r(m,f),p.xx*=f.sx,p.yy*=f.sy,h(g,f),p.xx*=f.sx,p.yy*=f.sy,Object.extend(f,{sx:p.xx,sy:p.yy})}}(),setTransform:function(t,e,i){if(t.setTransform)return t.setTransform.apply(t,e);this.transform(t,this.tInvertMatrix(i)),this.transform(t,e)},skewX:function(t,e){return this.transform(t,this.tSkewXMatrix(e))},skewY:function(t,e){return this.transform(t,this.tSkewYMatrix(e))},tRotate:function(t,e){var i=Math.cos(e),a=Math.sin(e),n=t[0]*i+t[2]*a,s=t[1]*i+t[3]*a,r=t[0]*-a+t[2]*i,h=t[1]*-a+t[3]*i;return t[0]=n,t[1]=s,t[2]=r,t[3]=h,t},tTranslate:function(t,e,i){return t[4]+=t[0]*e+t[2]*i,t[5]+=t[1]*e+t[3]*i,t},tScale:function(t,e,i){return t[0]*=e,t[1]*=e,t[2]*=i,t[3]*=i,t},tSkewX:function(t,e){return this.tMatrixMultiply(t,this.tSkewXMatrix(e))},tSkewY:function(t,e){return this.tMatrixMultiply(t,this.tSkewYMatrix(e))},tSkewXMatrix:function(t){return[1,0,Math.tan(t),1,0,0]},tSkewYMatrix:function(t){return[1,Math.tan(t),0,1,0,0]},tRotationMatrix:function(t){var e=Math.cos(t),i=Math.sin(t);return[e,i,-i,e,0,0]},tTranslationMatrix:function(t,e){return[1,0,0,1,t,e]},tScalingMatrix:function(t,e){return[t,0,0,e,0,0]},getTextBackend:function(){return this.textBackend==null&&(this.textBackend=this.detectTextBackend()),this.textBackend},detectTextBackend:function(){var t=this.getTestContext();return t.fillText?"HTML5":t.mozDrawText?"MozText":t.drawString?"DrawString":"NONE"},getSupportsPutImageData:function(){if(this.supportsPutImageData==null){var t=this.getTestContext(),e=t.putImageData;if(e)try{var i=t.getImageData(0,0,1,1);i[0]=255,i[1]=0,i[2]=255,i[3]=255,t.putImageData({width:1,height:1,data:i},0,0);var i=t.getImageData(0,0,1,1);e=[255,0,255,255].equals(i.data)}catch{e=!1}this.supportsPutImageData=e}return e},getSupportsIsPointInPath:function(){return this.supportsIsPointInPath==null&&(this.supportsIsPointInPath=!!this.getTestContext().isPointInPath),this.supportsIsPointInPath},getIsPointInPathMode:function(){return this.isPointInPathMode==null&&(this.isPointInPathMode=this.detectIsPointInPathMode()),this.isPointInPathMode},detectIsPointInPathMode:function(){var t=this.getTestContext(),e;return t.isPointInPath?(t.save(),t.translate(1,0),t.beginPath(),t.rect(0,0,1,1),t.isPointInPath(.3,.3)?e=this.USER_SPACE:e=this.DEVICE_SPACE,t.restore(),e):this.USER_SPACE},isPointInPath:function(t,e,i,a,n){var s;if(t.isPointInPath){if(this.getIsPointInPathMode()==this.USER_SPACE)if(t.setTransform)t.save(),t.setTransform(1,0,0,1,0,0),s=t.isPointInPath(e,i),t.restore();else{var r=this.tMatrixMultiplyPoint(this.tInvertMatrix(a),e,i);s=t.isPointInPath(r[0],r[1])}else s=t.isPointInPath(e,i);return s}else if(n&&n.isPointInPath){var r=this.tMatrixMultiplyPoint(this.tInvertMatrix(a),e,i);return n.isPointInPath(r[0],r[1])}else return!1}};window.RecordingContext=Klass({objectId:0,commands:[],isMockObject:!0,initialize:function(t){this.commands=t||[],Object.conditionalExtend(this,this.getMockContext())},getMockContext:function(){if(!RecordingContext.MockContext){var t=E.canvas(1,1),e=CanvasSupport.getContext(t,"2d"),i={};for(var a in e)typeof e[a]=="function"?i[a]=this.createRecordingFunction(a):i[a]=e[a];i.isPointInPath=null,i.transform=null,i.setTransform=null,RecordingContext.MockContext=i}return RecordingContext.MockContext},createRecordingFunction:function(t){if(t.search(/^set[A-Z]/)!=-1&&t!="setTransform"){var e=t.charAt(3).toLowerCase()+t.slice(4);return function(){this[e]=arguments[0],this.commands.push([t,$A(arguments)])}}else return function(){this.commands.push([t,$A(arguments)])}},clear:function(){this.commands=[]},getRecording:function(){return this.commands},serialize:function(t,e){return"("+{width:t,height:e,commands:this.getRecording()}.toSource()+")"},play:function(t){RecordingContext.play(t,this.getRecording())},createLinearGradient:function(){var t=this.objectId++;return this.commands.push([t,"=","createLinearGradient",$A(arguments)]),new MockGradient(this,t)},createRadialGradient:function(){var t=this.objectId++;return this.commands.push([t,"=","createRadialGradient",$A(arguments)]),new this.MockGradient(this,t)},createPattern:function(){var t=this.objectId++;return this.commands.push([t,"=","createPattern",$A(arguments)]),new this.MockGradient(this,t)},MockGradient:Klass({isMockObject:!0,initialize:function(t,e){this.recorder=t,this.id=e},addColorStop:function(){this.recorder.commands.push([this.id,"addColorStop",$A(arguments)])},toSource:function(){return{id:this.id,isMockObject:!0}.toSource()}})});RecordingContext.play=function(t,e){for(var i=[],a=0;a<e.length;a++){var n=e[a];if(n.length==2){var s=n[1];s[0]&&s[0].isMockObject?t[n[0]](i[s[0].id]):t[n[0]].apply(t,n[1])}else if(n.length==3){var r=i[n[0]];r[n[1]].apply(r,n[2])}else if(n.length==4)i[n[0]]=t[n[2]].apply(t,n[3]);else throw"Malformed command: "+n.toString()}};window.Transformable=Klass({needMatrixUpdate:!0,transform:function(t){var e=this.absoluteMatrix,i=this.x||this.y,a=this.rotation,n=this.scale!=null,s=this.skewX,r=this.skewY,h=this.matrix,o=this.transformList;if(this.needMatrixUpdate||!this.currentMatrix){if(this.currentMatrix||(this.currentMatrix=[1,0,0,1,0,0]),this.parent?this.__copyMatrix(this.parent.currentMatrix):this.__identityMatrix(),e&&this.__setMatrixMatrix(this.absoluteMatrix),i&&this.__translateMatrix(this.x,this.y),a&&this.__rotateMatrix(this.rotation),s&&this.__skewXMatrix(this.skewX),r&&this.__skewYMatrix(this.skewY),n&&this.__scaleMatrix(this.scale),h&&this.__matrixMatrix(this.matrix),o)for(var l=0;l<this.transformList.length;l++){var o=this.transformList[l];this["__"+o[0]+"Matrix"](o[1])}this.needMatrixUpdate=!1}t&&this.__setMatrix(t,this.currentMatrix)},distanceTo:function(t){return Curves.lineLength([this.x,this.y],[t.x,t.y])},angleTo:function(t){return Curves.lineAngle([this.x,this.y],[t.x,t.y])},__setMatrixMatrix:function(t){this.previousMatrix||(this.previousMatrix=[]);var e=this.previousMatrix,i=this.currentMatrix;e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=i[3],e[4]=i[4],e[5]=i[5],e=this.currentMatrix,i=t,e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=i[3],e[4]=i[4],e[5]=i[5]},__copyMatrix:function(t){var e=this.currentMatrix,i=t;e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=i[3],e[4]=i[4],e[5]=i[5]},__identityMatrix:function(){var t=this.currentMatrix;t[0]=1,t[1]=0,t[2]=0,t[3]=1,t[4]=0,t[5]=0},__translateMatrix:function(t,e){t.length?CanvasSupport.tTranslate(this.currentMatrix,t[0],t[1]):CanvasSupport.tTranslate(this.currentMatrix,t,e)},__rotateMatrix:function(t){if(t.length){if(t[0]%Math.PI*2==0)return;t[1]||t[2]?(CanvasSupport.tTranslate(this.currentMatrix,t[1],t[2]),CanvasSupport.tRotate(this.currentMatrix,t[0]),CanvasSupport.tTranslate(this.currentMatrix,-t[1],-t[2])):CanvasSupport.tRotate(this.currentMatrix,t[0])}else{if(t%Math.PI*2==0)return;CanvasSupport.tRotate(this.currentMatrix,t)}},__skewXMatrix:function(t){t.length&&t[0]?CanvasSupport.tSkewX(this.currentMatrix,t[0]):CanvasSupport.tSkewX(this.currentMatrix,t)},__skewYMatrix:function(t){t.length&&t[0]?CanvasSupport.tSkewY(this.currentMatrix,t[0]):CanvasSupport.tSkewY(this.currentMatrix,t)},__scaleMatrix:function(t){if(t.length==2){if(t[0]==1&&t[1]==1)return;CanvasSupport.tScale(this.currentMatrix,t[0],t[1])}else if(t.length==3){if(t[0]==1||t[0].length&&t[0][0]==1&&t[0][1]==1)return;CanvasSupport.tTranslate(this.currentMatrix,t[1],t[2]),t[0].length?CanvasSupport.tScale(this.currentMatrix,t[0][0],t[0][1]):CanvasSupport.tScale(this.currentMatrix,t[0],t[0]),CanvasSupport.tTranslate(this.currentMatrix,-t[1],-t[2])}else t!=1&&CanvasSupport.tScale(this.currentMatrix,t,t)},__matrixMatrix:function(t){CanvasSupport.tMatrixMultiply(this.currentMatrix,t)},__setMatrix:function(t,e){CanvasSupport.setTransform(t,e,this.previousMatrix)},__translate:function(t,e,i){e.length!=null?t.translate(e[0],e[1]):t.translate(e,i)},__rotate:function(t,e){if(e.length)if(e[1]||e[2]){if(e[0]%Math.PI*2==0)return;t.translate(e[1],e[2]),t.rotate(e[0]),t.translate(-e[1],-e[2])}else t.rotate(e[0]);else t.rotate(e)},__skewX:function(t,e){e.length&&e[0]?CanvasSupport.skewX(t,e[0]):CanvasSupport.skewX(t,e)},__skewY:function(t,e){e.length&&e[0]?CanvasSupport.skewY(t,e[0]):CanvasSupport.skewY(t,e)},__scale:function(t,e){e.length==2?t.scale(e[0],e[1]):e.length==3?(t.translate(e[1],e[2]),e[0].length?t.scale(e[0][0],e[0][1]):t.scale(e[0],e[0]),t.translate(-e[1],-e[2])):t.scale(e,e)},__matrix:function(t,e){CanvasSupport.transform(t,e)}});window.Timeline=Klass({startTime:null,repeat:!1,lastAction:0,initialize:function(t,e){this.repeat=t,this.keyframes=[]},addKeyframe:function(t,e,i){arguments.length==1?this.keyframes.push(t):this.keyframes.push({time:t,target:e,tween:i})},appendKeyframe:function(t,e,i){return this.lastAction+=t,this.addKeyframe(this.lastAction,e,i)},evaluate:function(t,e,i){this.startTime==null&&(this.startTime=e);var a=e-this.startTime;if(this.keyframes.length>0){for(var n,s,r,h=0;h<this.keyframes.length;h++)if(this.keyframes[h].time>a){n=h;break}if(n!=null&&(s=this.keyframes[n-1],r=this.keyframes[n]),!r)this.keyframes.atEnd||(this.keyframes.atEnd=!0,s=this.keyframes[this.keyframes.length-1],Object.extend(t,Object.clone(s.target)),this.repeat&&(this.startTime=e),t.changed=!0);else if(s){this.keyframes.atEnd=!1;var o=a-s.time,l=r.time-s.time,f=o/l;for(var u in r.target)s.target[u]!=null&&t.tweenVariable(u,s.target[u],r.target[u],f,r.tween)}}}});window.Animatable=Klass({tweenFunctions:{linear:function(t){return t},set:function(t){return Math.floor(t)},discrete:function(t){return Math.floor(t)},sine:function(t){return .5-.5*Math.cos(t*Math.PI)},sproing:function(t){return(.5-.5*Math.cos(t*3.59261946538606))*1.05263157894737},square:function(t){return t*t},cube:function(t){return t*t*t},sqrt:function(t){return Math.sqrt(t)},curt:function(t){return Math.pow(t,-.333333333333)}},initialize:function(){this.lastAction=0,this.timeline=[],this.keyframes=[],this.pendingKeyframes=[],this.pendingTimelineEvents=[],this.timelines=[],this.animators=[],this.addFrameListener(this.updateTimelines),this.addFrameListener(this.updateKeyframes),this.addFrameListener(this.updateTimeline),this.addFrameListener(this.updateAnimators)},updateTimelines:function(t,e){for(var i=0;i<this.timelines.length;i++)this.timelines[i].evaluate(this,t,e)},addTimeline:function(t){this.timelines.push(t)},removeTimeline:function(t){this.timelines.deleteFirst(t)},updateKeyframes:function(t,e){if(this.addPendingKeyframes(t),this.keyframes.length>0){for(var i,a,n,s=0;s<this.keyframes.length;s++)if(this.keyframes[s].time>t){i=s;break}if(i!=null&&(a=this.keyframes[i-1],n=this.keyframes[i]),!n)this.keyframes.atEnd||(this.keyframes.atEnd=!0,a=this.keyframes[this.keyframes.length-1],Object.extend(this,Object.clone(a.target)),this.changed=!0);else if(a){this.keyframes.atEnd=!1;var r=t-a.time,h=n.time-a.time,o=r/h;for(var l in n.target)a.target[l]!=null&&this.tweenVariable(l,a.target[l],n.target[l],o,n.tween)}}},addPendingKeyframes:function(t){if(this.pendingKeyframes.length>0){for(;this.pendingKeyframes.length>0;){var e=this.pendingKeyframes.shift();e.time==null&&(e.time=e.relativeTime+t),this.keyframes.push(e)}this.keyframes.stableSort(function(i,a){return i.time-a.time})}},updateTimeline:function(t,e){for(this.addPendingTimelineEvents(t);this.timeline[0]&&this.timeline[0].startTime<=t;){var i=this.timeline.shift(),a=!0;if(typeof i.action=="function"?a=i.action.call(this,t,e,i):this.animators.push(i.action),i.repeatEvery!=null&&a!=!1){if(i.repeatTimes!=null){if(i.repeatTimes<=0)continue;i.repeatTimes--}i.startTime+=i.repeatEvery,this.addTimelineEvent(i)}this.changed=!0}},addPendingTimelineEvents:function(t){if(this.pendingTimelineEvents.length>0){for(;this.pendingTimelineEvents.length>0;){var e=this.pendingTimelineEvents.shift();e.startTime||(e.startTime=e.relativeStartTime+t),this.timeline.push(e)}this.timeline.stableSort(function(i,a){return i.startTime-a.startTime})}},addTimelineEvent:function(t){this.pendingTimelineEvents.push(t)},updateAnimators:function(t,e){for(var i=0;i<this.animators.length;i++){var a=this.animators[i];a.startTime||(a.startTime=t);var n=t-a.startTime,s=n/a.duration,r=!1;s>=1?a.repeat?(a.repeat!==!0&&(a.repeat=Math.max(0,a.repeat-1)),a.accumulate&&(a.startValue=Object.clone(a.endValue),a.endValue=Object.sum(a.difference,a.endValue)),a.repeat==0?(r=!0,s=1):(a.startTime=t,s=s%1)):(s=1,r=!0):a.repeat&&a.repeat!==!0&&a.repeat<=s&&(r=!0,s=a.repeat),this.tweenVariable(a.variable,a.startValue,a.endValue,s,a.tween),r&&(this.animators.splice(i,1),i--)}},tweenVariable:function(t,e,i,a,n){typeof n!="function"&&(n=this.tweenFunctions[n]||this.tweenFunctions.linear);var s=n(a);if(typeof t!="function")if(e instanceof Array)for(var r=0;r<e.length;r++)this[t][r]=e[r]+s*(i[r]-e[r]);else this[t]=e+s*(i-e);else t.call(this,s,e,i);this.changed=!0},animate:function(t,r,h,a,n,s){var r=Object.clone(r),h=Object.clone(h);if(s||(s={}),s.additive){var o=Object.sub(h,r);r=Object.sum(r,this[t]),h=Object.sum(h,this[t])}typeof t!="function"&&(this[t]=Object.clone(r));var l={id:Animatable.uid++,variable:t,startValue:r,endValue:h,difference:o,duration:a,tween:n,repeat:s.repeat,additive:s.additive,accumulate:s.accumulate,pingpong:s.pingpong};return this.animators.push(l),l},removeAnimator:function(t){this.animators.deleteFirst(t)},animateTo:function(t,e,i,a,n){return this.animate(t,this[t],e,i,a,n)},animateFrom:function(t,e,i,a,n){return this.animate(t,e,this[t],i,a,n)},animateFactor:function(t,e,i,a,n,s){var r;if(e instanceof Array){r=[];for(var h=0;h<e.length;h++)r[h]=e[h]*i}else r=e*i;return this.animate(t,e,r,a,n,s)},animateToFactor:function(t,e,i,a,n){var s=this[t];return this.animateFactor(t,s,e,i,a,n)},addKeyframe:function(t,e,i){var a={relativeTime:t,target:e,tween:i};this.pendingKeyframes.push(a)},addKeyframeAt:function(t,e,i){var a={time:t,target:e,tween:i};this.pendingKeyframes.push(a)},appendKeyframe:function(t,e,i){return this.lastAction+=t,this.addKeyframe(this.lastAction,e,i)},every:function(t,e,i){var a={action:e,relativeStartTime:i?t:0,repeatEvery:t};return this.addTimelineEvent(a),a},at:function(t,e){var i={action:e,startTime:t};return this.addTimelineEvent(i),i},after:function(t,e){var i={action:e,relativeStartTime:t};return this.addTimelineEvent(i),i},afterFrame:function(t,e){var i=0,a;return a=function(n,s){i>=t&&(e.call(this),this.removeFrameListener(a)),i++},this.addFrameListener(a),a},everyFrame:function(t,e,i){var a=i?0:t,n;return n=function(s,r){a>=t&&(e.call(this)==!1&&this.removeFrameListener(n),a=0),a++},this.addFrameListener(n),n}});Animatable.uid=0;window.CanvasNode=Klass(Animatable,Transformable,{OBJECTBOUNDINGBOX:"objectBoundingBox",visible:!0,drawable:!0,display:null,visibility:null,catchMouse:!0,pickable:!1,underCursor:!1,zIndex:0,x:0,y:0,scale:1,rotation:0,matrix:null,absoluteMatrix:null,transformList:null,fill:null,stroke:null,strokeWidth:null,lineCap:null,lineJoin:null,miterLimit:null,absoluteOpacity:null,opacity:null,fillOpacity:null,strokeOpacity:null,compositeOperation:null,shadowColor:null,shadowBlur:null,shadowOffsetX:null,shadowOffsetY:null,font:null,textAlign:null,textBaseline:null,cursor:null,changed:!0,tagName:"g",getNextSibling:function(){return this.parentNode?this.parentNode.childNodes[this.parentNode.childNodes.indexOf(this)+1]:null},getPreviousSibling:function(){return this.parentNode?this.parentNode.childNodes[this.parentNode.childNodes.indexOf(this)-1]:null},initialize:function(t){this.root=this,this.currentMatrix=[1,0,0,1,0,0],this.previousMatrix=[1,0,0,1,0,0],this.needMatrixUpdate=!0,this.childNodes=[],this.frameListeners=[],this.eventListeners={},Animatable.initialize.call(this),t&&Object.extend(this,t)},clone:function(){var t=Object.clone(this);t.parent=t.root=null;for(var e in this)typeof this[e]=="object"&&(t[e]=Object.clone(this[e]));t.parent=t.root=null,t.childNodes=[],t.setRoot(null);for(var e=0;e<this.childNodes.length;e++){var i=this.childNodes[e].clone();t.append(i)}return t},cloneNode:function(){return this.clone()},getElementById:function(t){if(this.id==t)return this;for(var e=0;e<this.childNodes.length;e++){var i=this.childNodes[e].getElementById(t);if(i)return i}return null},$:function(t){return this.getElementById(t)},appendChild:function(){return this.append.apply(this,arguments)},append:function(t){for(var e=$A(arguments),i=0;i<e.length;i++)e[i].parent&&e[i].removeSelf(),this.childNodes.push(e[i]),e[i].parent=e[i].parentNode=this,e[i].setRoot(this.root);this.changed=!0},removeAllChildren:function(){this.remove.apply(this,this.childNodes)},removeChild:function(){return this.remove.apply(this,arguments)},remove:function(t){for(var e=arguments,i=0;i<e.length;i++)this.childNodes.deleteFirst(e[i]),delete e[i].parent,delete e[i].parentNode,e[i].setRoot(null);this.changed=!0},removeSelf:function(){this.parentNode&&this.parentNode.remove(this)},contains:function(t){for(;t;){if(t==this)return!0;t=t.parentNode}return!1},setRoot:function(t){t||(t=this),this.dispatchEvent({type:"rootChanged",canvasTarget:this,relatedTarget:t}),this.root=t;for(var e=0;e<this.childNodes.length;e++)this.childNodes[e].setRoot(t)},addFrameListener:function(t){this.frameListeners.push(t)},removeFrameListener:function(t){this.frameListeners.deleteFirst(t)},addEventListener:function(t,e,i){this.eventListeners[t]||(this.eventListeners[t]={capture:[],bubble:[]}),this.eventListeners[t][i?"capture":"bubble"].push(e)},when:function(t,e,i){this.addEventListener(t,e,i||!1)},removeEventListener:function(t,e,i){this.eventListeners[t]&&(this.eventListeners[t][i?"capture":"bubble"].deleteFirst(e),this.eventListeners[t].capture.length==0&&this.eventListeners[t].bubble.length==0&&delete this.eventListeners[t])},dispatchEvent:function(t){var e=t.type;t.canvasTarget||(e.search(/^(key|text)/i)==0?t.canvasTarget=this.root.focused||this.root.target:t.canvasTarget=this.root.target,t.canvasTarget||(t.canvasTarget=this));for(var i=[],a=t.canvasTarget;a&&a!=this;)i.push(a),a=a.parent;i.push(this),t.canvasPhase="capture";for(var n=i.length-1;n>=0;n--)if(!i[n].handleEvent(t))return!1;t.canvasPhase="bubble";for(var n=0;n<i.length;n++)if(!i[n].handleEvent(t))return!1;return!0},broadcastEvent:function(t){if(t.type,t.canvasPhase="capture",!this.handleEvent(t))return!1;for(var e=0;e<this.childNodes.length;e++)if(!this.childNodes[e].broadcastEvent(t))return!1;return t.canvasPhase="bubble",!!this.handleEvent(t)},handleEvent:function(t){var e=t.type,i=t.canvasPhase;this.cursor&&i=="capture"&&(t.cursor=this.cursor);var a=this.eventListeners[e];if(a=a&&a[i],a)for(var n=0;n<a.length;n++){var s=a[n].call(this,t);if(s==!1||t.stopped)return t.stopped||t.stopPropagation(),t.stopped=!0,!1}return!0},handleUpdate:function(t,e){this.update(t,e),this.willBeDrawn=(!this.parent||this.parent.willBeDrawn)&&(this.display?this.display!="none":this.visible);for(var i=0;i<this.childNodes.length;i++)this.childNodes[i].handleUpdate(t,e);this.parent&&this.changed&&(this.parent.changed=this.changed,this.changed=!1),this.needMatrixUpdate=!0},update:function(t,e){for(var i=this.frameListeners.slice(0),a=0;a<i.length;a++)this.frameListeners.includes(i[a])&&i[a].apply(this,arguments)},handlePick:function(t){if(this.display&&(this.visible=this.display!="none"),this.visibility&&(this.drawable=this.visibility!="hidden"),this.underCursor=!1,this.visible&&this.catchMouse&&this.root.absoluteMouseX!=null){t.save(),this.transform(t,!0),this.pickable&&this.drawable?(t.isPointInPath&&(t.beginPath(),this.drawPickingPath&&this.drawPickingPath(t)),this.underCursor=CanvasSupport.isPointInPath(this.drawPickingPath?t:!1,this.root.mouseX,this.root.mouseY,this.currentMatrix,this),this.underCursor&&(this.root.target=this)):this.underCursor=!1;var e=this.__getChildrenCopy();this.__zSort(e);for(var i=0;i<e.length;i++)e[i].handlePick(t),this.underCursor||(this.underCursor=e[i].underCursor);t.restore()}else for(var e=this.__getChildrenCopy();e.length>0;){var a=e.pop();a.underCursor&&(a.underCursor=!1,Array.prototype.push.apply(e,a.childNodes))}},__zSort:function(t){t.stableSort(function(e,i){return e.zIndex-i.zIndex})},__getChildrenCopy:function(){if(this.__childNodesCopy){for(;this.__childNodesCopy.length>this.childNodes.length;)this.__childNodesCopy.pop();for(var t=0;t<this.childNodes.length;t++)this.__childNodesCopy[t]=this.childNodes[t]}else this.__childNodesCopy=this.childNodes.slice(0);return this.__childNodesCopy},isPointInPath:!1,handleDraw:function(t){if(this.display&&(this.visible=this.display!="none"),this.visibility&&(this.drawable=this.visibility!="hidden"),!!this.visible){t.save();var e=t.fontFamily,i=t.fontSize,a=t.fillOn,n=t.strokeOn;if(this.fontFamily&&(t.fontFamily=this.fontFamily),this.fontSize&&(t.fontSize=this.fontSize),this.transform(t),this.clipPath)if(t.beginPath(),this.clipPath.units==this.OBJECTBOUNDINGBOX){var s=this.getSubtreeBoundingBox(!0);t.save(),t.translate(s[0],s[1]),t.scale(s[2],s[3]),this.clipPath.createSubtreePath(t,!0),t.restore(),t.clip()}else this.clipPath.createSubtreePath(t,!0),t.clip();this.drawable&&this.draw&&this.draw(t);var r=this.__getChildrenCopy();this.__zSort(r);for(var h=0;h<r.length;h++)r[h].handleDraw(t);t.fontFamily=e,t.fontSize=i,t.fillOn=a,t.strokeOn=n,t.restore()}},transform:function(t,e){if(Transformable.prototype.transform.call(this,t),!e){if(this.fill!=null){if(!this.fill||this.fill=="none")t.fillOn=!1;else if(t.fillOn=!0,this.fill!=!0){var i=Colors.parseColorStyle(this.fill,t);t.setFillStyle(i)}}this.stroke!=null&&(!this.stroke||this.stroke=="none"?t.strokeOn=!1:(t.strokeOn=!0,this.stroke!=!0&&t.setStrokeStyle(Colors.parseColorStyle(this.stroke,t)))),this.strokeWidth!=null&&t.setLineWidth(this.strokeWidth),this.lineCap!=null&&t.setLineCap(this.lineCap),this.lineJoin!=null&&t.setLineJoin(this.lineJoin),this.miterLimit!=null&&t.setMiterLimit(this.miterLimit),this.absoluteOpacity!=null&&t.setGlobalAlpha(this.absoluteOpacity),this.opacity!=null&&t.setGlobalAlpha(t.globalAlpha*this.opacity),this.compositeOperation!=null&&t.setGlobalCompositeOperation(this.compositeOperation),this.shadowColor!=null&&t.setShadowColor(Colors.parseColorStyle(this.shadowColor,t)),this.shadowBlur!=null&&t.setShadowBlur(this.shadowBlur),this.shadowOffsetX!=null&&t.setShadowOffsetX(this.shadowOffsetX),this.shadowOffsetY!=null&&t.setShadowOffsetY(this.shadowOffsetY),this.textAlign!=null&&t.setTextAlign(this.textAlign),this.textBaseline!=null&&t.setTextBaseline(this.textBaseline),this.font!=null&&t.setFont(this.font)}},drawPickingPath:!1,draw:!1,createSubtreePath:function(t,e){t.save(),e||this.transform(t,!0);for(var i=0;i<this.childNodes.length;i++)this.childNodes[i].createSubtreePath(t);t.restore()},getSubtreeBoundingBox:function(t){if(t){var e=this.parent;this.parent=null,this.needMatrixUpdate=!0}for(var i=this.getAxisAlignedBoundingBox(),a=0;a<this.childNodes.length;a++){var n=this.childNodes[a].getSubtreeBoundingBox();i?n&&this.mergeBoundingBoxes(i,n):i=n}return t&&(this.parent=e,this.needMatrixUpdate=!0),i},mergeBoundingBoxes:function(t,e){t[0]>e[0]&&(t[0]=e[0]),t[1]>e[1]&&(t[1]=e[1]),t[2]+t[0]<e[2]+e[0]&&(t[2]=e[2]+e[0]-t[0]),t[3]+t[1]<e[3]+e[1]&&(t[3]=e[3]+e[1]-t[1])},getAxisAlignedBoundingBox:function(){if(this.transform(null,!0),!this.getBoundingBox)return null;var t=this.getBoundingBox(),e=CanvasSupport.tMatrixMultiplyPoint(this.currentMatrix,t[0],t[1]),i=CanvasSupport.tMatrixMultiplyPoint(this.currentMatrix,t[0]+t[2],t[1]+t[3]),a=CanvasSupport.tMatrixMultiplyPoint(this.currentMatrix,t[0],t[1]+t[3]),n=CanvasSupport.tMatrixMultiplyPoint(this.currentMatrix,t[0]+t[2],t[1]),s=Math.min(e[0],i[0],a[0],n[0]),r=Math.max(e[0],i[0],a[0],n[0]),h=Math.min(e[1],i[1],a[1],n[1]),o=Math.max(e[1],i[1],a[1],n[1]);return[s,h,r-s,o-h]},makeDraggable:function(){this.addEventListener("dragstart",function(t){return this.dragStartPosition={x:this.x,y:this.y},t.stopPropagation(),t.preventDefault(),!1},!1),this.addEventListener("drag",function(t){return this.x=this.dragStartPosition.x+this.root.dragX/this.parent.currentMatrix[0],this.y=this.dragStartPosition.y+this.root.dragY/this.parent.currentMatrix[3],t.stopPropagation(),t.preventDefault(),!1},!1)}});window.Canvas=Klass(CanvasNode,{clear:!0,frameLoop:!1,recording:!1,opacity:1,frame:0,elapsed:0,frameDuration:30,speed:1,time:0,fps:0,currentRealFps:0,currentFps:0,fpsFrames:30,startTime:0,realFps:0,fixedTimestep:!1,playOnlyWhenFocused:!1,isPlaying:!0,redrawOnlyWhenChanged:!1,changed:!0,drawBoundingBoxes:!1,cursor:"default",mouseDown:!1,mouseEvents:[],absoluteMouseX:null,absoluteMouseY:null,mouseX:null,mouseY:null,elementNodeZIndexCounter:0,initialize:function(t,e){if(arguments.length>2){var i=arguments[0],a=arguments[1],n=arguments[2],e=arguments[3],t=E.canvas(a,n),s=E("div",t,{style:{overflow:"hidden",width:a+"px",height:n+"px",position:"relative"}});this.canvasContainer=s,i&&i.appendChild(s)}CanvasNode.initialize.call(this,e),this.mouseEventStack=[],this.canvas=t,t.canvas=this,this.width=this.canvas.width,this.height=this.canvas.height;var r=this;this.frameHandler=function(){r.onFrame()},this.canvas.addEventListener("DOMNodeInserted",function(h){h.target==this&&r.addEventListeners()},!1),this.canvas.addEventListener("DOMNodeRemoved",function(h){h.target==this&&r.removeEventListeners()},!1),this.canvas.parentNode&&this.addEventListeners(),this.startTime=new Date().getTime(),this.isPlaying&&this.play()},removeEventListeners:function(){},addEventListeners:function(){var t=this;this.canvas.parentNode.addMouseEvent=function(n){var s=t.canvas.getBoundingClientRect();t.absoluteMouseX=(n.clientX-s.left)*devicePixelRatio,t.absoluteMouseY=(n.clientY-s.top)*devicePixelRatio,s.width,s.height,t.mouseX=t.absoluteMouseX,t.mouseY=t.absoluteMouseY,t.addMouseEvent(t.mouseX,t.mouseY,t.mouseDown)},this.canvas.parentNode.contains=this.contains,this.canvas.parentNode.addEventListener("mousedown",function(n){t.mouseDown=!0,t.keyTarget!=t.target&&(t.keyTarget&&t.dispatchEvent({type:"blur",canvasTarget:t.keyTarget}),t.keyTarget=t.target,t.keyTarget&&t.dispatchEvent({type:"focus",canvasTarget:t.keyTarget})),this.addMouseEvent(n)},!0),this.canvas.parentNode.addEventListener("mouseup",function(n){this.addMouseEvent(n),t.mouseDown=!1},!0),this.canvas.parentNode.addEventListener("mousemove",function(n){if(this.addMouseEvent(n),t.prevClientX==null&&(t.prevClientX=n.clientX,t.prevClientY=n.clientY),t.dragTarget){var s=document.createEvent("MouseEvents");s.initMouseEvent("drag",!0,!0,window,n.detail,n.screenX,n.screenY,n.clientX,n.clientY,n.ctrlKey,n.altKey,n.shiftKey,n.metaKey,n.button,n.relatedTarget),s.canvasTarget=t.dragTarget,s.dx=n.clientX-t.prevClientX,s.dy=n.clientY-t.prevClientY,t.dragX+=s.dx,t.dragY+=s.dy,t.dispatchEvent(s)}if(t.mouseDown){if(!t.dragTarget&&t.target){t.dragTarget=t.target;var s=document.createEvent("MouseEvents");s.initMouseEvent("dragstart",!0,!0,window,n.detail,n.screenX,n.screenY,n.clientX,n.clientY,n.ctrlKey,n.altKey,n.shiftKey,n.metaKey,n.button,n.relatedTarget),s.canvasTarget=t.dragTarget,t.dragStartX=n.clientX,t.dragStartY=n.clientY,t.dragX=t.dragY=0,t.dispatchEvent(s)}}else if(t.dragTarget){var s=document.createEvent("MouseEvents");s.initMouseEvent("dragend",!0,!0,window,n.detail,n.screenX,n.screenY,n.clientX,n.clientY,n.ctrlKey,n.altKey,n.shiftKey,n.metaKey,n.button,n.relatedTarget),s.canvasTarget=t.dragTarget,t.dispatchEvent(s),t.dragX=t.dragY=0,t.dragTarget=!1}t.prevClientX=n.clientX,t.prevClientY=n.clientY},!0),this.canvas.parentNode.addEventListener("mouseout",function(n){CanvasNode.contains.call(this,n.relatedTarget)||(t.absoluteMouseX=t.absoluteMouseY=t.mouseX=t.mouseY=null)},!0);for(var e=this.dispatchEvent.bind(this),i=["mousemove","mouseover","mouseout","click","dblclick","mousedown","mouseup","keypress","keydown","keyup","DOMMouseScroll","mousewheel","mousemultiwheel","textInput","focus","blur"],a=0;a<i.length;a++)this.canvas.parentNode.addEventListener(i[a],e,!1);this.keys={},this.windowEventListeners={keydown:function(n){t.keyTarget&&(t.updateKeys(n),n.canvasTarget=t.keyTarget,t.dispatchEvent(n))},keyup:function(n){t.keyTarget&&(t.updateKeys(n),n.canvasTarget=t.keyTarget,t.dispatchEvent(n))},keypress:function(n){t.keyTarget&&(n.canvasTarget=t.keyTarget,t.dispatchEvent(n))},blur:function(n){t.absoluteMouseX=t.absoluteMouseY=null,t.playOnlyWhenFocused&&t.isPlaying&&(t.stop(),t.__blurStop=!0)},focus:function(n){t.__blurStop&&!t.isPlaying&&t.play()},mouseup:function(n){if(t.mouseDown=!1,t.dragTarget){var s=document.createEvent("MouseEvents");s.initMouseEvent("dragend",!0,!0,window,n.detail,n.screenX,n.screenY,n.clientX,n.clientY,n.ctrlKey,n.altKey,n.shiftKey,n.metaKey,n.button,n.relatedTarget),s.canvasTarget=t.dragTarget,t.dispatchEvent(s),t.dragTarget=!1}if(!t.canvas.parentNode.contains(n.target)){var r=t.dispatchEvent(n);return t.keyTarget&&(t.dispatchEvent({type:"blur",canvasTarget:t.keyTarget}),t.keyTarget=null),r}},mousemove:function(n){if(t.__blurStop&&!t.isPlaying&&t.play(),!t.canvas.parentNode.contains(n.target)&&t.mouseDown)return t.dispatchEvent(n)}},this.canvas.parentNode.addEventListener("DOMNodeRemoved",function(n){n.target==this&&t.removeWindowEventListeners()},!1),this.canvas.parentNode.addEventListener("DOMNodeInserted",function(n){n.target==this&&t.addWindowEventListeners()},!1),this.canvas.parentNode.parentNode&&this.addWindowEventListeners()},updateKeys:function(t){this.keys.shift=t.shiftKey,this.keys.ctrl=t.ctrlKey,this.keys.alt=t.altKey,this.keys.meta=t.metaKey;var e=t.type=="keydown";switch(t.keyCode){case 37:this.keys.left=e;break;case 38:this.keys.up=e;break;case 39:this.keys.right=e;break;case 40:this.keys.down=e;break;case 32:this.keys.space=e;break;case 13:this.keys.enter=e;break;case 9:this.keys.tab=e;break;case 8:this.keys.backspace=e;break;case 16:this.keys.shift=e;break;case 17:this.keys.ctrl=e;break;case 18:this.keys.alt=e;break}this.keys[t.keyCode]=e},addWindowEventListeners:function(){for(var t in this.windowEventListeners)window.addEventListener(t,this.windowEventListeners[t],!1)},removeWindowEventListeners:function(){for(var t in this.windowEventListeners)window.removeEventListener(t,this.windowEventListeners[t],!1)},addMouseEvent:function(t,e,i){var a=this.allocMouseEvent();a[0]=t,a[1]=e,a[2]=i,this.mouseEvents.push(a)},allocMouseEvent:function(){return this.mouseEventStack.length>0?this.mouseEventStack.pop():[null,null,null]},freeMouseEvent:function(t){this.mouseEventStack.push(t),this.mouseEventStack.length>100&&this.mouseEventStack.splice(0,this.mouseEventStack.length)},clearMouseEvents:function(){for(;this.mouseEvents.length>0;)this.freeMouseEvent(this.mouseEvents.pop())},play:function(){this.stop(),this.realTime=new Date().getTime(),this.frameLoop=setInterval(this.frameHandler,this.frameDuration),this.isPlaying=!0},stop:function(){this.__blurStop=!1,this.frameLoop&&(clearInterval(this.frameLoop),this.frameLoop=!1),this.isPlaying=!1},dispatchEvent:function(t){var e=CanvasNode.prototype.dispatchEvent.call(this,t);return t.cursor?this.canvas.style.cursor!=t.cursor&&(this.canvas.style.cursor=t.cursor):this.canvas.style.cursor!=this.cursor&&(this.canvas.style.cursor=this.cursor),e},onFrame:function(t,e){this.elementNodeZIndexCounter=0;var i=this.getContext();try{var a=new Date().getTime();this.currentRealElapsed=a-this.realTime,this.currentRealFps=1e3/this.currentRealElapsed;var n=this.frameDuration*this.speed;if(this.fixedTimestep||(n=this.currentRealElapsed*this.speed),this.realTime=a,t!=null?(this.time=t,e&&(n=e)):this.time+=n,this.previousTarget=this.target,this.target=null,this.catchMouse&&this.handlePick(i),this.previousTarget!=this.target){if(this.previousTarget){var s=document.createEvent("MouseEvents");s.initMouseEvent("mouseout",!0,!0,window,0,0,0,0,0,!1,!1,!1,!1,0,null),s.canvasTarget=this.previousTarget,this.dispatchEvent(s)}if(this.target){var s=document.createEvent("MouseEvents");s.initMouseEvent("mouseover",!0,!0,window,0,0,0,0,0,!1,!1,!1,!1,0,null),s.canvasTarget=this.target,this.dispatchEvent(s)}}if(this.handleUpdate(this.time,n),this.clearMouseEvents(),!this.redrawOnlyWhenChanged||this.changed){try{this.handleDraw(i)}catch(h){throw console.log(h),h}this.changed=!1}this.currentElapsed=new Date().getTime()-this.realTime,this.elapsed+=this.currentElapsed,this.currentFps=1e3/this.currentElapsed,this.frame++,this.frame%this.fpsFrames==0&&(this.fps=this.fpsFrames*1e3/this.elapsed,this.realFps=this.fpsFrames*1e3/(new Date().getTime()-this.startTime),this.elapsed=0,this.startTime=new Date().getTime())}catch(h){if(i)try{for(var r=0;r<1e3;r++)i.restore()}catch{}throw delete this.context,h}},getContext:function(){return this.recording?this.getRecordingContext():this.useMockContext?this.getMockContext():this.get2DContext()},get2DContext:function(){if(!this.context){var t=CanvasSupport.getContext(this.canvas,"2d");this.context=t}return this.context},getMockContext:function(){if(!this.fakeContext){var t=this.get2DContext();this.fakeContext={};var e=function(){return this};for(var i in t)typeof t[i]=="function"?this.fakeContext[i]=e:this.fakeContext[i]=t[i];this.fakeContext.isMockObject=!0,this.fakeContext.addColorStop=e}return this.fakeContext},getRecordingContext:function(){return this.recordingContext||(this.recordingContext=new RecordingContext),this.recordingContext},drawPickingPath:function(t){t.rect(0,0,this.canvas.width,this.canvas.height)},isPointInPath:function(t,e){return t>=0&&t<=this.canvas.width&&e>=0&&e<=this.canvas.height},draw:function(t){t.setGlobalAlpha(this.opacity),this.clear&&(t.fillOn?(t.beginPath(),t.rect(0,0,this.canvas.width,this.canvas.height),t.fill()):t.clearRect(0,0,this.canvas.width,this.canvas.height)),t.fillStyle="black",t.strokeStyle="black",t.fillOn=!1,t.strokeOn=!1}});window.LinkNode=Klass(CanvasNode,{href:null,target:"_self",cursor:"pointer",initialize:function(t,e,i){this.href=t,e&&(this.target=e),CanvasNode.initialize.call(this,i),this.setupLinkEventListeners()},setupLinkEventListeners:function(){this.addEventListener("click",function(t){if(t.button!=Mouse.RIGHT){var e=this.target;(t.ctrlKey||t.button==Mouse.MIDDLE)&&e=="_self"&&(e="_blank"),window.open(this.href,e)}},!1)}});window.AudioNode=Klass(CanvasNode,{ready:!1,autoPlay:!1,playing:!1,paused:!1,pan:0,volume:1,loop:!1,transformSound:!1,initialize:function(t,e){CanvasNode.initialize.call(this,e),this.filename=t,this.when("load",this._autoPlaySound),this.loadSound()},loadSound:function(){if(this.sound=CanvasSupport.getSoundObject(),!!this.sound){var t=this;this.sound.onready=function(){t.ready=!0,t.root.dispatchEvent({type:"ready",canvasTarget:t})},this.sound.onload=function(){t.loaded=!0,t.root.dispatchEvent({type:"load",canvasTarget:t})},this.sound.onerror=function(){t.root.dispatchEvent({type:"error",canvasTarget:t})},this.sound.onfinish=function(){t.loop?t.play():t.stop()},this.sound.load(this.filename)}},play:function(){this.playing=!0,this.needPlayUpdate=!0},stop:function(){this.playing=!1,this.needPlayUpdate=!0},pause:function(){if(this.needPauseUpdate){this.needPauseUpdate=!1;return}this.paused=!this.paused,this.needPauseUpdate=!0},setVolume:function(t){this.volume=t,this.needStatusUpdate=!0},setPan:function(t){this.pan=t,this.needStatusUpdate=!0},handleUpdate:function(){if(CanvasNode.handleUpdate.apply(this,arguments),this.willBeDrawn&&(this.transform(null,!0),this.sound||this.loadSound(),this.ready)){if(this.transformSound){var t=this.currentMatrix[4];this.currentMatrix[5];var e=this.currentMatrix[2],i=this.currentMatrix[3];this.currentMatrix[0],this.currentMatrix[1];var a=this.root.width*.5,n=Math.sqrt(e*e+i*i);this.setVolume(n),this.setPan((t-a)/a)}this.needPauseUpdate&&(this.needPauseUpdate=!1,this._pauseSound()),this.needPlayUpdate&&(this.needPlayUpdate=!1,this.playing?this._playSound():this._stopSound()),this.needStatusUpdate&&(this._setSoundVolume(),this._setSoundPan())}},_autoPlaySound:function(){this.autoPlay&&this.play()},_setSoundVolume:function(){this.sound.setVolume(this.volume)},_setSoundPan:function(){this.sound.setPan(this.pan)},_playSound:function(){if(this.sound.play()==!1)return this.playing=!1;this.root.dispatchEvent({type:"play",canvasTarget:this})},_stopSound:function(){this.sound.stop(),this.root.dispatchEvent({type:"stop",canvasTarget:this})},_pauseSound:function(){this.sound.pause(),this.root.dispatchEvent({type:this.paused?"pause":"play",canvasTarget:this})}});window.ElementNode=Klass(CanvasNode,{noScaling:!1,noAlpha:!1,inherit:"inherit",align:null,valign:null,xOffset:0,yOffset:0,initialize:function(t,e){CanvasNode.initialize.call(this,e),this.content=t,this.element=E("div",t),this.element.style.MozTransformOrigin=this.element.style.webkitTransformOrigin="0 0",this.element.style.position="absolute"},clone:function(){var t=CanvasNode.prototype.clone.call(this);return this.content&&this.content.cloneNode&&(t.content=this.content.cloneNode(!0)),t.element=E("div",t.content),t.element.style.position="absolute",t.element.style.MozTransformOrigin=t.element.style.webkitTransformOrigin="0 0",t},setRoot:function(t){CanvasNode.setRoot.call(this,t),this.element&&this.element.parentNode&&this.element.parentNode.removeChild&&this.element.parentNode.removeChild(this.element)},handleUpdate:function(t,e){CanvasNode.handleUpdate.call(this,t,e),!this.willBeDrawn||!this.visible||this.display=="none"||this.visibility=="hidden"||!this.drawable?this.element.style.display!="none"&&(this.element.style.display="none"):this.element.style.display=="none"&&(this.element.style.display="block")},addEventListener:function(t,e,i){var a=this,n=function(){e.apply(a,arguments)};return this.element.addEventListener(t,n,i||!1)},removeEventListener:function(t,e,i){var a=this,n=function(){e.apply(a,arguments)};return this.element.removeEventListener(t,n,i||!1)},draw:function(t){this.cursor&&this.element.style.cursor!=this.cursor&&(this.element.style.cursor=this.cursor),this.element.style.zIndex!=this.root.elementNodeZIndexCounter&&(this.element.style.zIndex=this.root.elementNodeZIndexCounter),this.root.elementNodeZIndexCounter++;var e=this.currentMatrix,i=this.xOffset,a=this.yOffset;if(this.fillBoundingBox&&this.parent&&this.parent.getBoundingBox){var n=this.parent.getBoundingBox();i+=n[0],a+=n[1]}var s=CanvasSupport.tMatrixMultiplyPoint(e.slice(0,4).concat([0,0]),i,a),r=this.currentMatrix[4]/devicePixelRatio+s[0],h=this.currentMatrix[5]/devicePixelRatio+s[1],o=this.currentMatrix[2]/devicePixelRatio,l=this.currentMatrix[3]/devicePixelRatio,f=this.currentMatrix[0]/devicePixelRatio,u=this.currentMatrix[1]/devicePixelRatio,c=Math.sqrt(o*o+l*l),d=Math.sqrt(f*f+u*u);t.fontFamily!=null&&(this.element.style.fontFamily=t.fontFamily);var g=CanvasSupport.isCSSTransformSupported();if(g&&!this.noScaling?this.element.style.MozTransform=this.element.style.webkitTransform="matrix("+e.map(A=>A/devicePixelRatio).join(",")+")":this.element.style.MozTransform=this.element.style.webkitTransform="",t.fontSize!=null?this.noScaling||g?this.element.style.fontSize=t.fontSize+"px":this.element.style.fontSize=t.fontSize*c+"px":this.noScaling||g?this.element.style.fontSize="inherit":this.element.style.fontSize=100*c+"%",this.noAlpha?this.element.style.opacity=1:this.element.style.opacity=t.globalAlpha,!this.element.parentNode&&this.root.canvas.parentNode){this.element.style.visibility="hidden",this.root.canvas.parentNode.appendChild(this.element);var m=!0}var p=this.color||this.fill;this.parent&&((!p||!p.length)&&(p=this.parent.color),(!p||!p.length)&&(p=this.parent.fill)),(!p||!p.length)&&(p=t.fillStyle),typeof p=="string"?p.search(/^rgba\(/)!=-1?this.element.style.color="rgb("+p.match(/\d+/g).slice(0,3).join(",")+")":this.element.style.color=p:p.length&&(this.element.style.color="rgb("+p.slice(0,3).map(Math.floor).join(",")+")");var w=0,S=0;if(n)this.element.style.width=Math.floor(d*n[2])+"px",this.element.style.height=Math.floor(c*n[3])+"px",this.eWidth=d,this.eHeight=c;else{this.element.style.width="",this.element.style.height="";var b=this.align||this.textAnchor,P=[0,0];b=="center"||b=="middle"?(w=-this.element.offsetWidth/2,P[0]="50%"):b=="right"&&(w=-this.element.offsetWidth,P[0]="100%");var C=this.valign;C=="center"||C=="middle"?(S=-this.element.offsetHeight/2,P[1]="50%"):C=="bottom"&&(S=-this.element.offsetHeight,P[1]="100%"),this.element.style.webkitTransformOrigin=this.element.style.MozTransformOrigin=P.join(" "),this.eWidth=this.element.offsetWidth/d,this.eHeight=this.element.offsetHeight/c}g&&!this.noScaling?(this.element.style.left=Math.floor(w)+"px",this.element.style.top=Math.floor(S)+"px"):(this.element.style.left=Math.floor(r+w)+"px",this.element.style.top=Math.floor(h+S)+"px"),m&&(this.element.style.visibility="visible")}});window.Drawable=Klass(CanvasNode,{pickable:!0,strokeMode:"above",ABOVE:"above",BELOW:"below",INSIDE:"inside",initialize:function(t){CanvasNode.initialize.call(this,t)},drawPickingPath:function(t){this.drawGeometry&&(t.beginPath(),this.drawGeometry(t))},isPointInPath:function(t,e){return!1},isVisible:function(t){var e=this.getAxisAlignedBoundingBox();if(!e)return!0;var i=e[0],a=e[0]+e[2],n=e[1],s=e[1]+e[3],r=this.root.width,h=this.root.height;if(this.root.drawBoundingBoxes){t.save();var o=this.getBoundingBox();t.beginPath(),t.rect(o[0],o[1],o[2],o[3]),t.strokeStyle="green",t.lineWidth=1,t.stroke(),t.restore(),t.save(),CanvasSupport.setTransform(t,[1,0,0,1,0,0],this.currentMatrix),t.beginPath(),t.rect(i,n,a-i,s-n),t.strokeStyle="red",t.lineWidth=1.5,t.stroke(),t.restore()}var l=!(a<0||i>r||s<0||n>h);return l},createSubtreePath:function(t,e){t.save(),e||this.transform(t,!0),this.drawGeometry&&this.drawGeometry(t);for(var i=0;i<this.childNodes.length;i++)this.childNodes[i].createSubtreePath(t);t.restore()},draw:function(t){if(this.drawGeometry){this.root.drawBoundingBoxes&&this.isVisible(t);var e=t.fillStyle.transformList||t.fillStyle.matrix||t.fillStyle.scale!=null||t.fillStyle.rotation||t.fillStyle.x||t.fillStyle.y,i=t.strokeStyle.transformList||t.strokeStyle.matrix||t.strokeStyle.scale!=null||t.strokeStyle.rotation||t.strokeStyle.x||t.strokeStyle.y;if(t.beginPath(),this.drawGeometry(t),t.strokeOn)switch(this.strokeMode){case this.ABOVE:t.fillOn&&this.doFill(t,e),this.doStroke(t,i);break;case this.BELOW:this.doStroke(t,i),t.fillOn&&this.doFill(t,e);break;case this.INSIDE:t.fillOn&&this.doFill(t,e),t.save();var a=t.lineWidth;t.setLineWidth(1),this.doStroke(t,i),t.setLineWidth(a),t.clip(),this.doStroke(t,i),t.restore();break}else t.fillOn&&this.doFill(t,e);this.drawMarkers(t),this.clip&&t.clip()}},doFill:function(t,e){if(e||this.getBoundingBox&&t.fillStyle.units==this.OBJECTBOUNDINGBOX){if(t.save(),this.getBoundingBox&&t.fillStyle.units==this.OBJECTBOUNDINGBOX){var i=this.getBoundingBox(),a=i[2],n=i[3];t.translate(i[0],i[1]),t.scale(a,n)}t.fillStyle.transform(t)}if(this.fillOpacity!=null){var s=t.globalAlpha;t.setGlobalAlpha(s*this.fillOpacity),t.fill(),t.globalAlpha=s}else t.fill();e&&t.restore()},doStroke:function(t,e){if(e||this.getBoundingBox&&t.strokeStyle.units==this.OBJECTBOUNDINGBOX){if(t.save(),this.getBoundingBox&&t.strokeStyle.units==this.OBJECTBOUNDINGBOX){var i=this.getBoundingBox(),a=i[2],n=i[3];t.translate(i[0],i[1]),t.scale(a,n)}t.strokeStyle.needMatrixUpdate=!0,t.strokeStyle.transform(t),a!=null&&CanvasSupport.tScale(t.strokeStyle.currentMatrix,a,n);var s=t.strokeStyle.currentMatrix,r=Math.sqrt(Math.max(s[0]*s[0]+s[1]*s[1],s[2]*s[2]+s[3]*s[3]));t.setLineWidth((t.lineWidth==null?1:t.lineWidth)/r)}if(this.strokeOpacity!=null){var h=t.globalAlpha;t.setGlobalAlpha(h*this.strokeOpacity),t.stroke(),t.globalAlpha=h}else t.stroke();e&&t.restore()},drawMarkers:function(t){var e=this.markerStart||this.marker,i=this.markerEnd||this.marker,a=this.markerMid||this.marker;if(e&&this.getStartPoint){var n=this.getStartPoint();e.orient!=null&&e.orient!="auto"&&(n.angle=e.orient);var s=e.markerUnits=="strokeWidth"?t.lineWidth:1;t.save(),t.translate(n.point[0],n.point[1]),t.scale(s,s),t.rotate(n.angle);var r=CanvasSupport.tRotate(CanvasSupport.tScale(CanvasSupport.tTranslate(this.currentMatrix.slice(0),n.point[0],n.point[1]),s,s),n.angle);e.__copyMatrix(r),e.handleDraw(t),t.restore()}if(i&&this.getEndPoint){var n=this.getEndPoint();i.orient!=null&&i.orient!="auto"&&(n.angle=i.orient);var s=i.markerUnits=="strokeWidth"?t.lineWidth:1;t.save(),t.translate(n.point[0],n.point[1]),t.scale(s,s),t.rotate(n.angle);var r=CanvasSupport.tRotate(CanvasSupport.tScale(CanvasSupport.tTranslate(this.currentMatrix.slice(0),n.point[0],n.point[1]),s,s),n.angle);i.__copyMatrix(r),i.handleDraw(t),t.restore()}if(a&&this.getMidPoints)for(var h=this.getMidPoints(),s=a.markerUnits=="strokeWidth"?t.lineWidth:1,o=0;o<h.length;o++){var n=h[o];t.save(),t.translate(n.point[0],n.point[1]),t.scale(s,s),a.orient!=null&&a.orient!="auto"&&(n.angle=i.orient),t.rotate(n.angle);var r=CanvasSupport.tRotate(CanvasSupport.tScale(CanvasSupport.tTranslate(this.currentMatrix.slice(0),n.point[0],n.point[1]),s,s),n.angle);a.__copyMatrix(r),a.handleDraw(t),t.restore()}},getStartPoint:!1,getEndPoint:!1,getMidPoints:!1,getBoundingBox:!1});window.Line=Klass(Drawable,{x1:0,y1:0,x2:0,y2:0,stroke:!0,initialize:function(t,e,i,a,n){this.x1=t,this.y1=e,this.x2=i,this.y2=a,Drawable.initialize.call(this,n)},drawGeometry:function(t){t.moveTo(this.x1,this.y1),t.lineTo(this.x2,this.y2)},getStartPoint:function(){return{point:[this.x1,this.y1],angle:Math.atan2(this.y2-this.y1,this.x2-this.x1)}},getEndPoint:function(){return{point:[this.x2,this.y2],angle:Math.atan2(this.y2-this.y1,this.x2-this.x1)}},getBoundingBox:function(){return[this.x1,this.y1,this.x2-this.x1,this.y2-this.y1]},getLength:function(){return Curves.lineLength([this.x1,this.y1],[this.x2,this.y2])}});window.Circle=Klass(Drawable,{cx:0,cy:0,radius:10,startAngle:0,endAngle:Math.PI*2,clockwise:!1,closePath:!0,includeCenter:!1,initialize:function(t,e){t!=null&&(this.radius=t),Drawable.initialize.call(this,e)},drawGeometry:function(t){if(this.radius!=0&&(this.includeCenter&&t.moveTo(this.cx,this.cy),t.arc(this.cx,this.cy,this.radius,this.startAngle,this.endAngle,this.clockwise),this.closePath)){var e=Math.cos(this.endAngle),i=Math.sin(this.endAngle);t.moveTo(this.cx+e*this.radius,this.cy+i*this.radius),t.closePath()}},isPointInPath:function(t,e){return t-=this.cx,e-=this.cy,t*t+e*e<=this.radius*this.radius},getBoundingBox:function(){return[this.cx-this.radius,this.cy-this.radius,2*this.radius,2*this.radius]}});window.Ellipse=Klass(Circle,{radiusX:0,radiusY:0,initialize:function(t,e,i){this.radiusX=t,this.radiusY=e,Circle.initialize.call(this,1,i)},drawGeometry:function(t){if(!(this.radiusX==0||this.radiusY==0)){var e=.5522847498,i=this.cx,a=this.cy,n=e*this.radiusX,s=e*this.radiusY;t.moveTo(i+this.radiusX,a),t.bezierCurveTo(i+this.radiusX,a-s,i+n,a-this.radiusY,i,a-this.radiusY),t.bezierCurveTo(i-n,a-this.radiusY,i-this.radiusX,a-s,i-this.radiusX,a),t.bezierCurveTo(i-this.radiusX,a+s,i-n,a+this.radiusY,i,a+this.radiusY),t.bezierCurveTo(i+n,a+this.radiusY,i+this.radiusX,a+s,i+this.radiusX,a)}},isPointInPath:function(t,e){return t-=this.cx,e-=this.cy,t/=this.radiusX,e/=this.radiusY,t*t+e*e<=1},getBoundingBox:function(){return[this.cx-this.radiusX,this.cy-this.radiusY,this.radiusX*2,this.radiusY*2]}});window.Spiral=Klass(Drawable,{cx:0,cy:0,startRadius:0,startAngle:0,endAngle:0,radiusFunction:function(t){return t},initialize:function(t,e){this.endAngle=t,Drawable.initialize.call(this,e)},drawGeometry:function(t){var e=this.cx,i=this.cy,a=this.startAngle,n=this.startRadius+this.radiusFunction(a);if(t.moveTo(e+Math.cos(a)*n,i-Math.sin(a)*n),this.startAngle<this.endAngle)for(a+=.1,n=this.startRadius+this.radiusFunction(a);a<this.endAngle;)t.lineTo(e+Math.cos(a)*n,i-Math.sin(a)*n),a+=.1,n=this.startRadius+this.radiusFunction(a);else for(a-=.1,n=this.startRadius+this.radiusFunction(a);a>this.endAngle;)t.lineTo(e+Math.cos(a)*n,i-Math.sin(a)*n),a-=.1,n=this.startRadius+this.radiusFunction(a);a=this.endAngle,n=this.startRadius+this.radiusFunction(a),t.lineTo(e+Math.cos(a)*n,i-Math.sin(a)*n)},isPointInPath:function(t,e){return!1}});window.Rectangle=Klass(Drawable,{cx:0,cy:0,x2:0,y2:0,width:0,height:0,rx:0,ry:0,centered:!1,initialize:function(t,e,i){t!=null&&(this.width=t,this.height=t),e!=null&&(this.height=e),Drawable.initialize.call(this,i)},drawGeometry:function(t){var e=this.cx,i=this.cy,a=this.width||this.x2-e,n=this.height||this.y2-i;if(!(a==0||n==0))if(this.centered&&(e-=.5*a,i-=.5*n),this.rx||this.ry){var s=Math.min(a*.5,this.rx||this.ry),r=Math.min(n*.5,this.ry||s),h=.5522847498,o=h*s,l=h*r;t.moveTo(e+s,i),t.lineTo(e-s+a,i),t.bezierCurveTo(e-s+a+o,i,e+a,i+r-l,e+a,i+r),t.lineTo(e+a,i+n-r),t.bezierCurveTo(e+a,i+n-r+l,e-s+a+o,i+n,e-s+a,i+n),t.lineTo(e+s,i+n),t.bezierCurveTo(e+s-o,i+n,e,i+n-r+l,e,i+n-r),t.lineTo(e,i+r),t.bezierCurveTo(e,i+r-l,e+s-o,i,e+s,i),t.closePath()}else a<0&&(e+=a),n<0&&(i+=n),t.rect(e,i,Math.abs(a),Math.abs(n))},isPointInPath:function(t,e){return t-=this.cx,e-=this.cy,this.centered&&(t+=this.width/2,e+=this.height/2),t>=0&&t<=this.width&&e>=0&&e<=this.height},getBoundingBox:function(){var t=this.cx,e=this.cy;return this.centered&&(t-=this.width/2,e-=this.height/2),[t,e,this.width,this.height]}});window.Polygon=Klass(Drawable,{segments:[],closePath:!0,initialize:function(t,e){this.segments=t,Drawable.initialize.call(this,e)},drawGeometry:function(t){if(!(!this.segments||this.segments.length<2)){var e=this.segments;t.moveTo(e[0],e[1]);for(var i=2;i<e.length;i+=2)t.lineTo(e[i],e[i+1]);this.closePath&&t.closePath()}},isPointInPath:function(t,e){if(!this.segments||this.segments.length<2)return!1;var i=this.getBoundingBox();return t>=i[0]&&t<=i[0]+i[2]&&e>=i[1]&&e<=i[1]+i[3]},getStartPoint:function(){if(!this.segments||this.segments.length<2)return{point:[0,0],angle:0};var t=0;return this.segments.length>2&&(t=Curves.lineAngle(this.segments.slice(0,2),this.segments.slice(2,4))),{point:this.segments.slice(0,2),angle:t}},getEndPoint:function(){if(!this.segments||this.segments.length<2)return{point:[0,0],angle:0};var t=0;return this.segments.length>2&&(t=Curves.lineAngle(this.segments.slice(-4,-2),this.segments.slice(-2))),{point:this.segments.slice(-2),angle:t}},getMidPoints:function(){if(!this.segments||this.segments.length<2)return[];for(var t=this.segments,e=[],i=2;i<t.length-2;i+=2){var a=t.slice(i-2,i),n=t.slice(i,i+2),s=t.slice(i+2,i+4),r=.5*(Curves.lineAngle(a,n)+Curves.lineAngle(n,s));e.push({point:n,angle:r})}return e},getBoundingBox:function(){for(var t=1/0,e=1/0,i=-1/0,a=-1/0,n=this.segments,s=0;s<n.length;s+=2){var r=n[s],h=n[s+1];r<t&&(t=r),r>i&&(i=r),h<e&&(e=h),h>a&&(a=h)}return[t,e,i-t,a-e]}});window.CatmullRomSpline=Klass(Drawable,{segments:[],loop:!1,closePath:!1,initialize:function(t,e){this.segments=t,Drawable.initialize.call(this,e)},drawGeometry:function(t){var e=this.currentMatrix[0],i=this.currentMatrix[1],a=this.currentMatrix[2],n=this.currentMatrix[3],s=e*e+i*i,r=a*a+n*n,h=Math.floor(Math.sqrt(Math.max(s,r))),o=this.compiled;(!o||o.scale!=h)&&(o=this.compile(h));for(var l=0;l<o.length;l++){var f=o[l];t[f[0]].apply(t,f[1])}this.closePath&&t.closePath()},compile:function(t){t||(t=1);var e=[];if(this.segments&&this.segments.length>=(this.loop?1:4)){var i=this.segments;this.loop&&(i=i.slice(0),i.unshift(i[i.length-1]),i.push(i[1]),i.push(i[2]));var a=1/(15*(t+.5)),n,s,r,h,o;e.push(["moveTo",i[1].slice(0)]),o=i[1];for(var l=1;l<i.length-2;l++){n=i[l-1],s=i[l],r=i[l+1],h=i[l+2];for(var f=0;f<1;f+=a)o=Curves.catmullRomPoint(n,s,r,h,f),e.push(["lineTo",o])}o=Curves.catmullRomPoint(n,s,r,h,1),e.push(["lineTo",o])}return e.scale=t,this.compiled=e,e},getBoundingBox:function(){for(var t=1/0,e=1/0,i=-1/0,a=-1/0,n=this.compiled?this.compiled:this.compile(),s=0;s<n.length;s++)for(var r=n[s][1],h=0;h<r.length;h+=2){var o=r[h],l=r[h+1];o<t&&(t=o),o>i&&(i=o),l<e&&(e=l),l>a&&(a=l)}return[t,e,i-t,a-e]},pointAt:function(t){if(!this.segments)return[0,0];if(this.segments.length>=(this.loop?1:4)){var e=this.segments;this.loop&&(e=e.slice(0),e.unshift(e[e.length-1]),e.push(e[1]),e.push(e[2]));var i=t*(e.length-3),a=Math.floor(i),n=i-a,s=e[a],r=e[a+1],h=e[a+2],o=e[a+3];return Curves.catmullRomPoint(s,r,h,o,n)}else return this.segments[0]},pointAngleAt:function(t){if(!this.segments)return{point:[0,0],angle:0};if(this.segments.length>=(this.loop?1:4)){var e=this.segments;this.loop&&(e=e.slice(0),e.unshift(e[e.length-1]),e.push(e[1]),e.push(e[2]));var i=t*(e.length-3),a=Math.floor(i),n=i-a,s=e[a],r=e[a+1],h=e[a+2],o=e[a+3];return Curves.catmullRomPointAngle(s,r,h,o,n)}else return{point:this.segments[0]||[0,0],angle:0}}});window.Path=Klass(Drawable,{segments:[],closePath:!1,initialize:function(t,e){this.segments=t,Drawable.initialize.call(this,e)},drawGeometry:function(t){for(var e=this.getSegments(),i=0;i<e.length;i++){var a=e[i];t[a[0]].apply(t,a[1])}this.closePath&&t.closePath()},isPointInPath:function(t,e){var i=this.getBoundingBox();return t>=i[0]&&t<=i[0]+i[2]&&e>=i[1]&&e<=i[1]+i[3]},getBoundingBox:function(){if(!(this.compiled&&this.compiledBoundingBox)){for(var t=1/0,e=1/0,i=-1/0,a=-1/0,n=this.getSegments(),s=0;s<n.length;s++)for(var r=n[s][1],h=0;h<r.length;h+=2){var o=r[h],l=r[h+1];o<t&&(t=o),o>i&&(i=o),l<e&&(e=l),l>a&&(a=l)}this.compiledBoundingBox=[t,e,i-t,a-e]}return this.compiledBoundingBox},getStartPoint:function(){var t=this.getSegments();if(!t||!t[0])return{point:[0,0],angle:0};var e=t[0],i=e[1],a=[i[i.length-2],i[i.length-1]],n=t[1],s=0;return n&&(c2=n[1],s=Curves.lineAngle(a,[c2[c2.length-2],c2[c2.length-1]])),{point:a,angle:s}},getEndPoint:function(){var t=this.getSegments();if(!t||!t[0])return{point:[0,0],angle:0};var e=t[t.length-1],i=e[1],a=[i[i.length-2],i[i.length-1]],n=t[t.length-2],s=0;return n&&(c2=n[1],s=Curves.lineAngle([c2[c2.length-2],c2[c2.length-1]],a)),{point:a,angle:s}},getMidPoints:function(){var t=this.getSegments();if(this.vertices)return this.vertices.slice(1,-1);for(var e=[],i=1;i<t.length-1;i++){var a=t[i-1][1].slice(-2),n=t[i][1].slice(0,2);if(t[i-1].length>2)var s=t[i-1][1].slice(-4,-2),r=.5*(Curves.lineAngle(s,a)+Curves.lineAngle(a,n));else var r=Curves.lineAngle(a,n);e.push({point:a,angle:r});var h=t[i][2];if(h!=null){for(i++;t[i]&&t[i][2]==h;)i++;i--}}return e},getSegments:function(){return typeof this.segments=="string"?(!this.compiled||this.segments!=this.compiledSegments)&&(this.compiled=this.compileSVGPath(this.segments),this.compiledSegments=this.segments):this.compiled||(this.compiled=Object.clone(this.segments)),this.compiled},compileSVGPath:function(t){for(var e=t.split(/(?=[a-z])/i),i=0,a=0,n,s,r,h=[],o=0;o<e.length;o++){var l=e[o],f=l.match(/[a-z]/i);if(!f)return[];f=f[0];var u=l.match(/[+-]?\d+(\.\d+(e\d+(\.\d+)?)?)?/gi);switch(u&&(u=u.map(parseFloat)),f){case"M":i=u[0],a=u[1],n=s=null,h.push(["moveTo",[i,a]]);break;case"m":i+=u[0],a+=u[1],n=s=null,h.push(["moveTo",[i,a]]);break;case"L":i=u[0],a=u[1],n=s=null,h.push(["lineTo",[i,a]]);break;case"l":i+=u[0],a+=u[1],n=s=null,h.push(["lineTo",[i,a]]);break;case"H":i=u[0],n=s=null,h.push(["lineTo",[i,a]]);break;case"h":i+=u[0],n=s=null,h.push(["lineTo",[i,a]]);break;case"V":a=u[0],n=s=null,h.push(["lineTo",[i,a]]);break;case"v":a+=u[0],n=s=null,h.push(["lineTo",[i,a]]);break;case"C":i=u[4],a=u[5],n=u[2],s=u[3],h.push(["bezierCurveTo",u]);break;case"c":h.push(["bezierCurveTo",[u[0]+i,u[1]+a,u[2]+i,u[3]+a,u[4]+i,u[5]+a]]),n=i+u[2],s=a+u[3],i+=u[4],a+=u[5];break;case"S":(n==null||!r.match(/[sc]/i))&&(n=i,s=a),h.push(["bezierCurveTo",[i-(n-i),a-(s-a),u[0],u[1],u[2],u[3]]]),n=u[0],s=u[1],i=u[2],a=u[3];break;case"s":(n==null||!r.match(/[sc]/i))&&(n=i,s=a),h.push(["bezierCurveTo",[i-(n-i),a-(s-a),i+u[0],a+u[1],i+u[2],a+u[3]]]),n=i+u[0],s=a+u[1],i+=u[2],a+=u[3];break;case"Q":n=u[0],s=u[1],i=u[2],a=u[3],h.push(["quadraticCurveTo",u]);break;case"q":h.push(["quadraticCurveTo",[u[0]+i,u[1]+a,u[2]+i,u[3]+a]]),n=i+u[0],s=a+u[1],i+=u[2],a+=u[3];break;case"T":n==null||!r.match(/[qt]/i)?(n=i,s=a):(n=i-(n-i),s=a-(s-a)),h.push(["quadraticCurveTo",[n,s,u[0],u[1]]]),n=i-(n-i),s=a-(s-a),i=u[0],a=u[1];break;case"t":n==null||!r.match(/[qt]/i)?(n=i,s=a):(n=i-(n-i),s=a-(s-a)),h.push(["quadraticCurveTo",[n,s,i+u[0],a+u[1]]]),i+=u[0],a+=u[1];break;case"A":for(var d=this.solveArc(i,a,u),c=0;c<d.length;c++)d[c][2]=o;h.push.apply(h,d),i=u[5],a=u[6];break;case"a":u[5]+=i,u[6]+=a;for(var d=this.solveArc(i,a,u),c=0;c<d.length;c++)d[c][2]=o;h.push.apply(h,d),i=u[5],a=u[6];break;case"Z":h.push(["closePath",[]]);break;case"z":h.push(["closePath",[]]);break}r=f}return h},solveArc:function(t,e,i){for(var a=i[0],n=i[1],s=i[2],r=i[3],h=i[4],o=i[5],l=i[6],f=this.arcToSegments(o,l,a,n,r,h,s,t,e),u=[],c=0;c<f.length;c++)u.push(["bezierCurveTo",this.segmentToBezier.apply(this,f[c])]);return u},arcToSegments:function(t,e,i,a,n,s,r,h,o){var l=r*(Math.PI/180),f=Math.sin(l),u=Math.cos(l);i=Math.abs(i),a=Math.abs(a);var c=u*(h-t)*.5+f*(o-e)*.5,d=u*(o-e)*.5-f*(h-t)*.5,g=c*c/(i*i)+d*d/(a*a);g>1&&(g=Math.sqrt(g),i*=g,a*=g);var m=u/i,p=f/i,w=-f/a,S=u/a,b=m*h+p*o,P=w*h+S*o,C=m*t+p*e,A=w*t+S*e,N=(C-b)*(C-b)+(A-P)*(A-P),I=1/N-.25;I<0&&(I=0);var R=Math.sqrt(I);s==n&&(R=-R);var O=.5*(b+C)-R*(A-P),F=.5*(P+A)+R*(C-b),B=Math.atan2(P-F,b-O),z=Math.atan2(A-F,C-O),k=z-B;k<0&&s==1?k+=2*Math.PI:k>0&&s==0&&(k-=2*Math.PI);for(var D=Math.ceil(Math.abs(k/(Math.PI*.5+.001))),_=[],L=0;L<D;L++){var G=B+L*k/D,X=B+(L+1)*k/D;_[L]=[O,F,G,X,i,a,f,u]}return _},segmentToBezier:function(t,e,i,a,n,s,r,h){var o=h*n,l=-r*s,f=r*n,u=h*s,c=.5*(a-i),d=8/3*Math.sin(c*.5)*Math.sin(c*.5)/Math.sin(c),g=t+Math.cos(i)-d*Math.sin(i),m=e+Math.sin(i)+d*Math.cos(i),p=t+Math.cos(a),w=e+Math.sin(a),S=p+d*Math.sin(a),b=w-d*Math.cos(a);return[o*g+l*m,f*g+u*m,o*S+l*b,f*S+u*b,o*p+l*w,f*p+u*w]},getLength:function(){var t=this.getSegments();if(t.arcLength==null){t.arcLength=0;for(var e=0,i=0,a=0;a<t.length;a++){var n=t[a][1];if(!(n.length<2)){switch(t[a][0]){case"bezierCurveTo":t[a][3]=Curves.cubicLength([e,i],[n[0],n[1]],[n[2],n[3]],[n[4],n[5]]);break;case"quadraticCurveTo":t[a][3]=Curves.quadraticLength([e,i],[n[0],n[1]],[n[2],n[3]]);break;case"lineTo":t[a][3]=Curves.lineLength([e,i],[n[0],n[1]]);break}t[a][3]&&(t.arcLength+=t[a][3]),e=n[n.length-2],i=n[n.length-1]}}}return t.arcLength},pointAngleAt:function(t,e){for(var i=[],a=this.getSegments(),n=this.getLength(),s=0,r=0,h=0;h<a.length;h++){var o=a[h];o[1].length<2||(o[0]!="moveTo"&&i.push([s,r,o]),s=o[1][o[1].length-2],r=o[1][o[1].length-1])}if(i.length<1)return{point:[s,r],angle:0};if(t>=1)var l=1,o=i[i.length-1];else if(e&&e.discrete)var f=Math.floor(t*i.length),o=i[f],l=0;else if(e&&e.linear)var f=t*i.length,l=f-Math.floor(f),o=i[Math.floor(f)];else{for(var u=t*n,c=0,f,l,h=0;h<i.length;h++){if(c+i[h][2][3]>u){f=h,l=(u-c)/i[h][2][3];break}c+=i[h][2][3]}var o=i[f]}var d=0,g=o[2][0],m=o[2][1];switch(g){case"bezierCurveTo":return Curves.cubicLengthPointAngle([o[0],o[1]],[m[0],m[1]],[m[2],m[3]],[m[4],m[5]],l);case"quadraticCurveTo":return Curves.quadraticLengthPointAngle([o[0],o[1]],[m[0],m[1]],[m[2],m[3]],l);case"lineTo":s=Curves.linearValue(o[0],m[0],l),r=Curves.linearValue(o[1],m[1],l),d=Curves.lineAngle([o[0],o[1]],[m[0],m[1]],l);break}return{point:[s,r],angle:d}}});window.ImageNode=Klass(Drawable,{centered:!1,usePattern:!1,sX:0,sY:0,sWidth:null,sHeight:null,dX:0,dY:0,dWidth:null,dHeight:null,initialize:function(t,e){this.image=t,Drawable.initialize.call(this,e)},drawGeometry:function(t){if(Object.isImageLoaded(this.image)){var e=this.dWidth==null?this.image.width:this.dWidth,i=this.dHeight==null?this.image.height:this.dHeight,a=this.dX+(this.centered?-e*.5:0),n=this.dY+(this.centered?-i*.5:0);if(this.dWidth!=null)this.sWidth!=null?t.drawImage(this.image,this.sX,this.sY,this.sWidth,this.sHeight,a,n,e,i):t.drawImage(this.image,a,n,e,i);else if(e=this.image.width,i=this.image.height,this.usePattern){this.imagePattern||(this.imagePattern=new Pattern(this.image,"repeat"));var s=this.imagePattern.compiled;s||(s=this.imagePattern.compile(t)),t.save(),t.beginPath(),t.rect(a,n,e,i),t.setFillStyle(s),t.fill(),t.restore(),t.beginPath()}else t.drawImage(this.image,a,n)}else{var e=this.dWidth,i=this.dHeight;if(!(e&&i))return;var a=this.dX+(this.centered?-e*.5:0),n=this.dY+(this.centered?-i*.5:0)}t.rect(a,n,e,i)},drawPickingPath:function(t){var e=this.dX+(this.centered?-this.image.width*.5:0),i=this.dY+(this.centered?-this.image.height*.5:0),a=this.dWidth,n=this.dHeight;this.dWidth==null&&(a=this.image.width,n=this.image.height),t.rect(e,i,a,n)},isPointInPath:function(t,e){t-=this.dX,e-=this.dY,this.centered&&(t+=this.image.width*.5,e+=this.image.height*.5);var i=this.dWidth,a=this.dHeight;return this.dWidth==null&&(i=this.image.width,a=this.image.height),t>=0&&t<=i&&e>=0&&e<=a},getBoundingBox:function(){x=this.dX,y=this.dY,this.centered&&(x-=this.image.width*.5,y-=this.image.height*.5);var t=this.dWidth,e=this.dHeight;return this.dWidth==null&&(t=this.image.width,e=this.image.height),[x,y,t,e]}});ImageNode.load=function(t){var e=new Image;e.src=t;var i=new ImageNode(e);return i};window.TextNode=Klass(Drawable,{text:"Text",align:"start",baseline:"alphabetic",accuratePicking:!1,asPath:!1,pathGeometry:null,maxWidth:null,width:0,height:20,cx:0,cy:0,__drawMethodName:"draw"+CanvasSupport.getTextBackend(),__pickingMethodName:"drawPickingPath"+CanvasSupport.getTextBackend(),initialize:function(t,e){this.lastText=this.text,this.text=t,Drawable.initialize.call(this,e)},drawGeometry:function(t){this.drawUsing(t,this.__drawMethodName)},drawPickingPath:function(t){this.drawUsing(t,this.__pickingMethodName)},drawUsing:function(t,e){!this.text||this.text.length==0||((this.lastText!=this.text||this.lastStyle!=t.font)&&(this.dimensions=this.measureText(t),this.lastText=this.text,this.lastStyle=t.font),this[e]&&this[e](t))},measureText:function(t){var e="measureText"+CanvasSupport.getTextBackend().capitalize();return this[e]?this[e](t):{width:0,height:0}},computeXForAlign:function(){if(this.align=="left")return 0;if(this.align=="right")return-this.dimensions.width;if(this.align=="center")return-this.dimensions.width*.5},measureTextHTML5:function(t){return{width:t.measureText(this.text).width,height:20}},drawHTML5:function(t){t.fillText(this.text,this.cx,this.cy,this.maxWidth)},drawPickingPathHTML5:function(t){var e=15,i=this.cy-e;t.rect(this.cx,i,this.dimensions.width,this.dimensions.height)},measureTextMozText:function(t){return{width:t.mozMeasureText(this.text),height:20}},drawMozText:function(t){var e=this.cx+this.computeXForAlign(),i=this.cy+0;this.pathGeometry?(this.pathGeometry.draw(t),t.mozDrawTextAlongPath(this.text,this.path)):(t.save(),t.translate(e,i),this.asPath?t.mozPathText(this.text):t.mozDrawText(this.text),t.restore())},drawPickingPathMozText:function(t){var e=this.cx+this.computeXForAlign(),i=this.cy+0;if(this.pathGeometry)this.pathGeometry.draw(t);else if(this.accuratePicking)t.save(),t.translate(e,i),t.mozPathText(this.text),t.restore();else{var a=15,n=i-a;t.rect(e,n,this.dimensions.width,this.dimensions.height)}},drawDrawString:function(t){var e=this.cx+this.computeXForAlign(),i=this.cy+0;t.drawString(e,i,this.text)},measureTextPerfectWorld:function(t){return t.measureText(this.text)},drawPerfectWorld:function(t){this.pathGeometry?(this.pathGeometry.draw(t),this.asPath?t.pathTextAlongPath(this.text):t.drawTextAlongPath(this.text)):this.asPath?t.pathText(this.text):t.drawText(this.text)},drawPickingPathPerfectWorld:function(t){this.accuratePicking?this.pathGeometry?t.pathTextAlongPath(this.text):t.pathText(this.text):this.pathGeometry?t.textRectAlongPath(this.text):t.textRect(this.text)}});window.Gradient=Klass({type:"linear",isPattern:!0,startX:0,startY:0,endX:1,endY:0,startRadius:0,endRadius:1,colorStops:[],initialize:function(t){this.colorStops=[[0,"#000000"],[1,"#FFFFFF"]],t&&Object.extend(this,t)},compile:function(t){if(this.type=="linear")var e=t.createLinearGradient(this.startX,this.startY,this.endX,this.endY);else var e=t.createRadialGradient(this.startX,this.startY,this.startRadius,this.endX,this.endY,this.endRadius);for(var i=0;i<this.colorStops.length;i++){var a=this.colorStops[i];if(typeof a[1]=="string")e.addColorStop(a[0],a[1]);else{var n=a[1],s=n.length==3?1:n[3],r="rgba("+n.slice(0,3).map(Math.round).join(",")+", "+s+")";e.addColorStop(a[0],r)}}return Object.extend(e,Transformable.prototype),e.transformList=this.transformList,e.scale=this.scale,e.x=this.x,e.y=this.y,e.matrix=this.matrix,e.rotation=this.rotation,e.units=this.units,e.isMockObject||(this.compiled=e),e}});window.Pattern=Klass({isPattern:!0,repeat:"repeat",initialize:function(t,e){this.image=t,e&&(this.repeat=e)},compile:function(t){var e=t.createPattern(this.image,this.repeat);return Object.extend(e,Transformable.prototype),e.transformList=this.transformList,e.scale=this.scale,e.x=this.x,e.y=this.y,e.matrix=this.matrix,e.rotation=this.rotation,e.units=this.units,e.isMockObject||(this.compiled=e),e}});window.SVGParser={load:function(t,e){if(!e.onSuccess)throw"Need to provide an onSuccess function.";e.filename||(e.filename=t);var i=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("MSXML2.XMLHTTP.3.0");i.open("GET",t,!0),i.overrideMimeType("text/xml");var a=!1;i.onreadystatechange=function(){if(i.readyState==4)if(i.status==200||i.status==0){try{var n=i.responseXML,s=SVGParser.parse(n,e);s.svgRootElement=n}catch(r){e.onFailure&&e.onFailure(i,r,t,e);return}e.onSuccess(s,i,t,e)}else e.onFailure&&!a&&e.onFailure(i,null,t,e);else i.readyState==3&&e.onLoading&&e.onLoading(i,t,e)};try{i.send(null)}catch(n){e.onFailure&&(e.onFailure(i,n,t,e),a=!0),i.abort()}},parse:function(t,e){var i=new CanvasNode,a=e.width,n=e.height,s=e.fontSize;i.innerWidth=a||window.innerWidth,i.innerHeight=n||window.innerHeight,i.innerSize=Math.sqrt(a*a+n*n)/Math.sqrt(2),i.fontSize=s||12,i.filename=e.filename||".";var r={},h={ids:{},classes:{},tags:{}};return i.color=e.currentColor||"black",this.parseChildren(t,i,r,h),i.defs=r,i.style=h,i},parsePreserveAspectRatio:function(s,e,i,a,n){var s=s||"",r=s.split(/\s+/),h=r[0]=="defer";h&&r.shift();var o=r[0]||"xMidYMid",l=r[1]||"meet",f=e/a,u=i/n,c={x:0,y:0,w:f,h:u};if(o=="none")return c;c.w=c.h=(l=="meet"?Math.min:Math.max)(f,u);var d=o.slice(1,4).toLowerCase(),g=o.slice(5,8).toLowerCase(),m=this.SVGAlignMap[d]||0,p=this.SVGAlignMap[g]||0;return c.x=m*(e-a*c.w),c.y=p*(i-n*c.h),c},SVGAlignMap:{min:0,mid:.5,max:1},SVGTagMapping:{svg:function(t,e,i,a){var n=new Rectangle;n.width=0,n.height=0,n.doFill=function(){},n.doStroke=function(){},n.drawMarkers=function(){},n.fill="black",n.stroke="none";var s=t.getAttribute("viewBox"),r=t.getAttribute("width"),h=t.getAttribute("height");if(r?h||(h=r):r=h,r)var o=this.parseUnit(r,e,"x"),l=this.parseUnit(h,e,"y");if(s){xywh=s.match(/[-+]?\d+/g).map(parseFloat),n.cx=xywh[0],n.cy=xywh[1],n.width=xywh[2],n.height=xywh[3];var f=e.innerWidth=n.width,u=e.innerHeight=n.height;e.innerSize=Math.sqrt(f*f+u*u)/Math.sqrt(2),t.getAttribute("overflow")!="visible"&&(n.clip=!0)}if(r){if(s){var c=t.getAttribute("preserveAspectRatio"),d=this.parsePreserveAspectRatio(c,o,l,n.width,n.height);n.cx-=d.x/d.w,n.cy-=d.y/d.h,n.width=o/d.w,n.height=l/d.h,n.x+=d.x,n.y+=d.y,n.scale=[d.w,d.h]}e.docWidth=o,e.docHeight=l}return n},marker:function(t,e){var i=new CanvasNode;i.draw=function(o){this.overflow!="hidden"&&this.viewBox||(o.beginPath(),o.rect(this.viewBox[0],this.viewBox[1],this.viewBox[2],this.viewBox[3]),o.clip())};var a=-this.parseUnit(t.getAttribute("refX"),e,"x")||0,n=-this.parseUnit(t.getAttribute("refY"),e,"y")||0;if(i.transformList=[["translate",[a,n]]],i.markerUnits=t.getAttribute("markerUnits")||"strokeWidth",i.markerWidth=this.parseUnit(t.getAttribute("markerWidth"),e,"x")||3,i.markerHeight=this.parseUnit(t.getAttribute("markerHeight"),e,"y")||3,i.overflow=t.getAttribute("overflow")||"hidden",i.viewBox=t.getAttribute("viewBox"),i.orient=t.getAttribute("orient")||0,i.orient&&i.orient!="auto"&&(i.orient=parseFloat(i.orient)*SVGMapping.DEG_TO_RAD_FACTOR),i.viewBox){i.viewBox=i.viewBox.strip().split(/[\s,]+/g).map(parseFloat);var s=i.viewBox[2]-i.viewBox[0],r=i.viewBox[3]-i.viewBox[1];if(i.markerWidth){var h=sy=Math.min(i.markerWidth/s,i.markerHeight/r);i.transformList.unshift(["scale",[h,sy]])}}return i},clipPath:function(t,e){var i=new CanvasNode;return i.units=t.getAttribute("clipPathUnits"),i},title:function(t,e){e.root.title=t.textContent},desc:function(t,e){e.root.description=t.textContent},metadata:function(t,e){e.root.metadata=t},parseAnimateTag:function(t,e){var i=SVGParser.SVGTagMapping.parseTime(t.getAttribute("begin")),a=SVGParser.SVGTagMapping.parseTime(t.getAttribute("dur")),n=SVGParser.SVGTagMapping.parseTime(t.getAttribute("end"));a==null&&(a=n-i),a=isNaN(a)?0:a;var s=t.getAttribute("attributeName"),r=t.getAttribute("fill");e.tagName=="rect"&&(s=="x"&&(s="cx"),s=="y"&&(s="cy"));var h=t.getAttribute("accumulate")=="sum",o=t.getAttribute("additive");o?o=o=="sum":o=h;var l=t.getAttribute("repeatCount");if(l=="indefinite"?l=!0:l=parseFloat(l),!l&&a>0){var f=t.getAttribute("repeatDur");f=="indefinite"?l=!0:l=SVGParser.SVGTagMapping.parseTime(f)/a}return{after:isNaN(i)?0:i,duration:a,restart:t.getAttribute("restart"),calcMode:t.getAttribute("calcMode"),additive:o,accumulate:h,repeat:l,variable:s,fill:r}},parseTime:function(t){if(!t)return null;if(t.match(/[0-9]$/)){var e=t.split(":"),i=e[e.length-1]||0,a=e[e.length-2]||0,n=e[e.length-3]||0;return(parseFloat(n)*3600+parseFloat(a)*60+parseFloat(i))*1e3}else{var s=60;return t.match(/s$/i)?s=1:t.match(/h$/i)&&(s=3600),parseFloat(t)*s*1e3}},animate:function(t,e){var i=this.parseUnit(t.getAttribute("from"),e,"x"),a=this.parseUnit(t.getAttribute("to"),e,"x"),n=this.parseUnit(t.getAttribute("by"),e,"x"),s=SVGParser.SVGTagMapping.parseAnimateTag(t,e);if(t.getAttribute("values")){var r=this,h=t.getAttribute("values");h=h.split(";").map(function(o){var l=o.split(/[, ]+/);return l.length>2?l.map(function(f){return r.parseUnit(f,e,"x")}):l.length>1?[r.parseUnit(l[0],e,"x"),r.parseUnit(l[1],e,"y")]:r.parseUnit(o,e,"x")})}else a==null&&(a=i+n);e.after(s.after,function(){if(s.fill=="remove"){var o=Object.clone(this[s.variable]);this.after(s.duration,function(){this[s.variable]=o})}if(h){if(s.additive){var l=this[s.variable];h=h.map(function(p){return Object.sum(p,l)})}var f=0,u=[];if(h[0]instanceof Array)for(var c=1;c<h.length;c++){var d=Object.sub(h[c]-h[c-1]),g=Math.sqrt(d.reduce(function(p,w){return p+w*w},0));u.push(g),f+=g}else for(var c=1;c<h.length;c++){var g=Math.abs(h[c]-h[c-1]);u.push(g),f+=g}var m=function(p){if(p==1)this[s.variable]=h[h.length-1];else{if(s.calcMode=="paced"){for(var w=p*f,S=0,b,P,C=0;C<u.length;C++){if(S+u[C]>w){b=C,P=(w-S)/u[C];break}S+=u[C]}var A=b,N=A+1}else var b=p*(h.length-1),A=Math.floor(b),P=b-A,N=A+1;this.tweenVariable(s.variable,h[A],h[N],P,s.calcMode)}};this.animate(m,i,a,s.duration,"linear",{repeat:s.repeat,additive:s.additive,accumulate:s.accumulate})}else i==null&&(i=this[s.variable],n!=null&&(a=i+n)),s.additive&&(i=Object.sum(i,this[s.variable]),a=Object.sum(a,this[s.variable])),this.animate(s.variable,i,a,s.duration,s.calcMode,{repeat:s.repeat,additive:s.additive,accumulate:s.accumulate})})},set:function(t,e){var i=t.getAttribute("to"),a=SVGParser.SVGTagMapping.parseAnimateTag(t,e);e.after(a.after,function(){if(a.fill=="remove"){var n=Object.clone(this[a.variable]);this.after(a.duration,function(){this[a.variable]=n})}this[a.variable]=i})},animateMotion:function(t,e){var i;if(t.getAttribute("path"))i=new Path(t.getAttribute("path"));else if(t.getAttribute("values")){var a=t.getAttribute("values");i=new Path("M"+a.split(";").join("L"))}else if(t.getAttribute("from")||t.getAttribute("to")||t.getAttribute("by")){var n=t.getAttribute("from"),s=t.getAttribute("to"),r=t.getAttribute("by");n||(n="0,0"),s?s="L"+s:s="l"+r,i=new Path("M"+n+s)}var h=new CanvasNode;h.__motionPath=i;var o=t.getAttribute("rotate"),l=SVGParser.SVGTagMapping.parseAnimateTag(t,e);return e.after(l.after,function(){if(l.fill=="remove"){var f=this.x,u=this.y;this.after(l.duration,function(){this.x=f,this.y=u})}var c=function(d){var g=h.__motionPath.pointAngleAt(d,{discrete:l.calcMode=="discrete",linear:l.calcMode=="linear"});this.x=g.point[0],this.y=g.point[1],o=="auto"?this.rotation=g.angle:o=="auto-reverse"&&(this.rotation=g.angle+Math.PI)};this.animate(c,0,1,l.duration,"linear",{repeat:l.repeat,additive:l.additive,accumulate:l.accumulate})}),h},mpath:function(t,e,i){var a=t.getAttribute("xlink:href");a=a.replace(/^#/,""),this.getDef(i,a,function(n){e.__motionPath=n})},animateColor:function(t,e,i){var a=t.getAttribute("from"),n=t.getAttribute("to");a=SVGParser.SVGMapping.__parseStyle(a,null,i),n=SVGParser.SVGMapping.__parseStyle(n,null,i);var s=SVGParser.SVGTagMapping.parseAnimateTag(t,e);e.after(s.after,function(){if(s.fill=="remove"){var r=Object.clone(this[s.variable]);this.after(s.duration,function(){this[s.variable]=r})}this.animate(s.variable,a,n,s.duration,"linear",{repeat:s.repeat,additive:s.additive,accumulate:s.accumulate})})},animateTransform:function(t,e){var i=t.getAttribute("from"),a=t.getAttribute("to"),n=t.getAttribute("by"),s=SVGParser.SVGTagMapping.parseAnimateTag(t,e);i&&(i=i.split(/[ ,]+/).map(parseFloat)),a&&(a=a.split(/[ ,]+/).map(parseFloat)),n&&(n=n.split(/[ ,]+/).map(parseFloat)),s.variable=t.getAttribute("type"),s.variable=="rotate"?(s.variable="rotation",i&&(i=i.map(function(r){return r*Math.PI/180})),a&&(a=a.map(function(r){return r*Math.PI/180})),n&&(n=n.map(function(r){return r*Math.PI/180}))):s.variable.match(/^skew/)&&(i&&(i=i.map(function(r){return r*Math.PI/180})),a&&(a=a.map(function(r){return r*Math.PI/180})),n&&(n=n.map(function(r){return r*Math.PI/180}))),a==null&&(a=Object.sum(i,n)),e.after(s.after,function(){if(s.variable=="translate"){if(i==null&&(i=[this.x,this.y],n!=null&&(a=Object.sum(i,n))),s.fill=="remove"){var r=this.x,h=this.y;this.after(s.duration,function(){this.x=r,this.y=h})}this.animate("x",i[0],a[0],s.duration,"linear",{repeat:s.repeat,additive:s.additive,accumulate:s.accumulate}),i[1]!=null&&this.animate("y",i[1],a[1],s.duration,"linear",{repeat:s.repeat,additive:s.additive,accumulate:s.accumulate})}else{if(i&&i.length==1&&(i=i[0]),a&&a.length==1&&(a=a[0]),n&&n.length==1&&(n=n[0]),i==null&&(i=this[s.variable],n!=null&&(a=Object.sum(i,n))),s.variable=="scale"&&s.additive&&(s.additive=!1),s.fill=="remove"){var o=Object.clone(this[s.variable]);this.after(s.duration,function(){this[s.variable]=o})}this.animate(s.variable,i,a,s.duration,"linear",{repeat:s.repeat,additive:s.additive,accumulate:s.accumulate})}})},a:function(t,e){var i=t.getAttribute("xlink:href")||t.getAttribute("href"),a=t.getAttribute("target"),n=new LinkNode(i,a);return n},use:function(t,e,i,a){var n=t.getAttribute("xlink:href")||t.getAttribute("href"),s=new CanvasNode;return n&&(n=n.replace(/^#/,""),this.getDef(i,n,function(r){var h=r.clone(),o=s.parent;o?(s.stroke&&(h.stroke=s.stroke),s.fill&&(h.fill=s.fill),s.append(h)):s=h})),s},image:function(t,e,i,a){var n=t.getAttribute("xlink:href")||t.getAttribute("href");n&&n.search(/^[a-z]+:/i)!=0&&(n=e.root.filename.split("/").slice(0,-1).join("/")+"/"+n);var s=new ImageNode(n?Object.loadImage(n):null);return s.fill="none",s.dX=this.parseUnit(t.getAttribute("x"),e,"x")||0,s.dY=this.parseUnit(t.getAttribute("y"),e,"y")||0,s.srcWidth=this.parseUnit(t.getAttribute("width"),e,"x"),s.srcHeight=this.parseUnit(t.getAttribute("height"),e,"y"),s},path:function(t){return new Path(t.getAttribute("d"))},polygon:function(t){return new Polygon(t.getAttribute("points").toString().strip().split(/[\s,]+/).map(parseFloat))},polyline:function(t){return new Polygon(t.getAttribute("points").toString().strip().split(/[\s,]+/).map(parseFloat),{closePath:!1})},rect:function(t,e){var i=new Rectangle(this.parseUnit(t.getAttribute("width"),e,"x"),this.parseUnit(t.getAttribute("height"),e,"y"));return i.cx=this.parseUnit(t.getAttribute("x"),e,"x")||0,i.cy=this.parseUnit(t.getAttribute("y"),e,"y")||0,i.rx=this.parseUnit(t.getAttribute("rx"),e,"x")||0,i.ry=this.parseUnit(t.getAttribute("ry"),e,"y")||0,i},line:function(t,e){var i=this.parseUnit(t.getAttribute("x1"),e,"x")||0,a=this.parseUnit(t.getAttribute("y1"),e,"y")||0,n=this.parseUnit(t.getAttribute("x2"),e,"x")||0,s=this.parseUnit(t.getAttribute("y2"),e,"y")||0,r=new Line(i,a,n,s);return r},circle:function(t,e){var i=new Circle(this.parseUnit(t.getAttribute("r"),e)||0);return i.cx=this.parseUnit(t.getAttribute("cx"),e,"x")||0,i.cy=this.parseUnit(t.getAttribute("cy"),e,"y")||0,i},ellipse:function(t,e){var i=new Ellipse(this.parseUnit(t.getAttribute("rx"),e,"x")||0,this.parseUnit(t.getAttribute("ry"),e,"y")||0);return i.cx=this.parseUnit(t.getAttribute("cx"),e,"x")||0,i.cy=this.parseUnit(t.getAttribute("cy"),e,"y")||0,i},text:function(t,e){var i;{var a=E("div",t.textContent.strip());a.style.marginTop="-1em",a.style.whiteSpace="nowrap";var i=new ElementNode(a);return i.xOffset=this.parseUnit(t.getAttribute("x"),e,"x")||0,i.yOffset=this.parseUnit(t.getAttribute("y"),e,"y")||0,i}},style:function(t,e,i,a){this.parseStyle(t,a)},defs:function(t,e,i,a){return new CanvasNode({visible:!1})},linearGradient:function(t,e,i,a){var n=new Gradient({type:"linear"});n.color=e.color,t.getAttribute("color")&&SVGParser.SVGMapping.color(n,t.getAttribute("color"),i,a),n.svgNode=t;var s=t.getAttribute("x1"),r=t.getAttribute("y1"),h=t.getAttribute("x2"),o=t.getAttribute("y2"),l=t.getAttribute("gradientTransform");return n.units=t.getAttribute("gradientUnits")||"objectBoundingBox",s&&(n.startX=parseFloat(s)*(s.charAt(s.length-1)=="%"?.01:1)),r&&(n.startY=parseFloat(r)*(r.charAt(r.length-1)=="%"?.01:1)),h&&(n.endX=parseFloat(h)*(h.charAt(h.length-1)=="%"?.01:1)),o&&(n.endY=parseFloat(o)*(o.charAt(o.length-1)=="%"?.01:1)),l&&this.applySVGTransform(n,l,i,a),this.parseStops(n,t,i,a),n},radialGradient:function(t,e,i,a){var n=new Gradient({type:"radial"});n.color=e.color,t.getAttribute("color")&&SVGParser.SVGMapping.color(n,t.getAttribute("color"),i,a),n.svgNode=t;var s=t.getAttribute("r"),r=t.getAttribute("fx"),h=t.getAttribute("fy"),o=t.getAttribute("cx"),l=t.getAttribute("cy"),f=t.getAttribute("gradientTransform");return n.units=t.getAttribute("gradientUnits")||"objectBoundingBox",s&&(n.endRadius=parseFloat(s)*(s.charAt(s.length-1)=="%"?.01:1)),r&&(n.startX=parseFloat(r)*(r.charAt(r.length-1)=="%"?.01:1)),h&&(n.startY=parseFloat(h)*(h.charAt(h.length-1)=="%"?.01:1)),o&&(n.endX=parseFloat(o)*(o.charAt(o.length-1)=="%"?.01:1)),l&&(n.endY=parseFloat(l)*(l.charAt(l.length-1)=="%"?.01:1)),f&&this.applySVGTransform(n,f,i,a),this.parseStops(n,t,i,a),n}},parseChildren:function(t,e,i,a){for(var n=e,s=0;s<t.childNodes.length;s++){var r=t.childNodes[s],h=!1;if(r.childNodes){if(r.tagName&&(this.SVGTagMapping[r.tagName]?h=this.SVGTagMapping[r.tagName].call(this,r,e,i,a):h=new CanvasNode,h)){if(h.root=e.root,h.fontSize=n.fontSize,h.strokeWidth=n.strokeWidth,r.attributes)for(var o=0;o<r.attributes.length;o++){var l=r.attributes[o];this.SVGMapping[l.nodeName]&&this.SVGMapping[l.nodeName](h,l.nodeValue,i,a)}h.id&&this.setDef(i,h.id,h),h.tagName=r.tagName,this.applySVGTransform(h,r.getAttribute("transform"),i,a),this.applySVGStyle(h,r.getAttribute("style"),i,a),h.tagName&&a.tags[h.tagName]&&this.applySVGStyle(h,a.tags[h.tagName],i,a),h.className&&a.classes[h.className]&&this.applySVGStyle(h,a.classes[h.className],i,a),h.id&&a.ids[h.id]&&this.applySVGStyle(h,a.ids[h.id],i,a),h.marker||(h.marker=n.marker),h.markerStart||(h.markerStart=n.markerStart),h.markerEnd||(h.markerEnd=n.markerEnd),h.markerMid||(h.markerMid=n.markerMid)}h&&h.setRoot&&(h.zIndex=s,e.append(h),this.parseChildren(r,h,i,a))}}},parseStyle:function(t,e){for(var i=t.textContent,a=i.split(/\}/m),n=0;n<a.length;n++){var s=a[n],r=s.split(/\{/m);if(!(r.length<2)){var h=r[0].strip(),o=r[1].strip();switch(h.charAt(0)){case".":e.classes[h.slice(1)]=o;break;case"#":e.ids[h.slice(1)]=o;break;default:e.tags[h]=o;break}}}},parseStops:function(t,e,i,a){var n=e.getAttribute("xlink:href");t.colorStops=[],n&&(n=n.replace(/^#/,""),this.getDef(i,n,function(d){t.colorStops.length==0&&(t.colorStops=d.colorStops)}));for(var s=[],r=0;r<e.childNodes.length;r++){var h=e.childNodes[r];if(h.tagName=="stop"){var o=parseFloat(h.getAttribute("offset"));h.getAttribute("offset").search(/%/)!=-1&&(o*=.01);var l=[o];l.color=t.color;for(var f=0;f<h.attributes.length;f++){var u=h.attributes[f];this.SVGMapping[u.nodeName]&&this.SVGMapping[u.nodeName](l,u.nodeValue,i,a)}this.applySVGStyle(l,h.getAttribute("style"),i,a);var c=h.getAttribute("id");c&&this.setDef(i,c,l),s.push(l)}}s.length>0&&(t.colorStops=s)},applySVGTransform:function(t,e,i,a){if(e){t.transformList=[];for(var n=e.match(/[a-z]+\s*\([^)]*\)/ig),s=0;s<n.length;s++){var r=n[s].split("("),h=r[0].strip();if(this.SVGMapping[h]){var o=r[1].strip().slice(0,-1);this.SVGMapping[h](t,o,i,a)}}this.breakDownTransformList(t)}},breakDownTransformList:function(t){var e=t.transformList;if(t.transformList.length==1){var i=e[0];if(i[0]=="translate")t.x=i[1][0],t.y=i[1][1];else if(i[0]=="scale")t.scale=i[1];else if(i[0]=="rotate")t.rotation=i[1];else if(i[0]=="matrix")t.matrix=i[1];else if(i[0]=="skewX")t.skewX=i[1][0];else if(i[0]=="skewY")t.skewY=i[1][0];else return;t.transformList=null}},applySVGStyle:function(t,e,i,a){if(e)for(var n=e.split(";"),s=0;s<n.length;s++){var r=n[s].split(":"),h=r[0].strip();if(this.SVGMapping[h]){var o=r[1].strip();this.SVGMapping[h](t,o,i,a)}}},getDef:function(t,e,i){t[e]&&t[e]instanceof Array?t[e].push(i):t[e]?i(t[e]):t[e]=[i]},setDef:function(t,e,i){if(t[e]&&t[e]instanceof Array)for(var a=0;a<t[e].length;a++)t[e][a](i);t[e]=i},parseUnit:function(t,e,i){return t==null?null:this.parseUnitMultiplier(t,e,i)*parseFloat(t.strip())},parseUnitMultiplier:function(t,e,i){var a=this.getCmInPixels();return t.search(/cm$/i)!=-1?a:t.search(/mm$/i)!=-1?.1*a:t.search(/pt$/i)!=-1?.0352777778*a:t.search(/pc$/i)!=-1?.4233333333*a:t.search(/in$/i)!=-1?2.54*a:t.search(/em$/i)!=-1?e.fontSize:t.search(/ex$/i)!=-1?e.fontSize/2:t.search(/%$/i)!=-1?i=="x"?e.root.innerWidth*.01:i=="y"?e.root.innerHeight*.01:e.root.innerSize*.01:1},getCmInPixels:function(){if(!this.cmInPixels){var t=E("div",{style:{margin:"0px",padding:"0px",width:"1cm",height:"1cm",position:"absolute",visibility:"hidden"}});document.body.appendChild(t);var e=t.offsetWidth;document.body.removeChild(t),this.cmInPixels=e||38}return this.cmInPixels},getEmInPixels:function(){if(!this.emInPixels){var t=E("div",{style:{margin:"0px",padding:"0px",width:"1em",height:"1em",position:"absolute",visibility:"hidden"}});document.body.appendChild(t);var e=t.offsetWidth;document.body.removeChild(t),this.emInPixels=e||12}return this.emInPixels},getExInPixels:function(){if(!this.exInPixels){var t=E("div",{style:{margin:"0px",padding:"0px",width:"1ex",height:"1ex",position:"absolute",visibility:"hidden"}});document.body.appendChild(t);var e=t.offsetWidth;document.body.removeChild(t),this.exInPixels=e||6}return this.exInPixels},SVGMapping:{DEG_TO_RAD_FACTOR:Math.PI/180,RAD_TO_DEG_FACTOR:180/Math.PI,parseUnit:function(t,e,i){return SVGParser.parseUnit(t,e,i)},class:function(t,e){t.className=e},marker:function(t,e,i){SVGParser.getDef(i,e.replace(/^url\(#|\)$/g,""),function(a){t.marker=a})},"marker-start":function(t,e,i){SVGParser.getDef(i,e.replace(/^url\(#|\)$/g,""),function(a){t.markerStart=a})},"marker-end":function(t,e,i){SVGParser.getDef(i,e.replace(/^url\(#|\)$/g,""),function(a){t.markerEnd=a})},"marker-mid":function(t,e,i){SVGParser.getDef(i,e.replace(/^url\(#|\)$/g,""),function(a){t.markerMid=a})},"clip-path":function(t,e,i){SVGParser.getDef(i,e.replace(/^url\(#|\)$/g,""),function(a){t.clipPath=a})},id:function(t,e){t.id=e},translate:function(t,e){var i=e.split(/[\s,]+/).map(parseFloat);t.transformList.push(["translate",[i[0],i[1]||0]])},rotate:function(t,e){if(!(e=="auto"||e=="auto-reverse")){var i=e.split(/[\s,]+/).map(parseFloat),a=i[0]*this.DEG_TO_RAD_FACTOR;i.length>1?t.transformList.push(["rotate",[a,i[1],i[2]||0]]):t.transformList.push(["rotate",[a]])}},scale:function(t,e){var i=e.split(/[\s,]+/).map(parseFloat),a=["scale"];i.length>1?a[1]=[i[0],i[1]]:a[1]=[i[0],i[0]],t.transformList.push(a)},matrix:function(t,e){var i=e.split(/[\s,]+/).map(parseFloat);t.transformList.push(["matrix",i])},skewX:function(t,e){var i=parseFloat(e)*this.DEG_TO_RAD_FACTOR;t.transformList.push(["skewX",[i]])},skewY:function(t,e){var i=parseFloat(e)*this.DEG_TO_RAD_FACTOR;t.transformList.push(["skewY",[i]])},opacity:function(t,e){t.opacity=parseFloat(e)},display:function(t,e){t.display=e},visibility:function(t,e){t.visibility=e},"stroke-miterlimit":function(t,e){t.miterLimit=parseFloat(e)},"stroke-linecap":function(t,e){t.lineCap=e},"stroke-linejoin":function(t,e){t.lineJoin=e},"stroke-width":function(t,e){t.strokeWidth=this.parseUnit(e,t)},fill:function(t,e,i,a){t.fill=this.__parseStyle(e,t.fill,i,t.color)},stroke:function(t,e,i,a){t.stroke=this.__parseStyle(e,t.stroke,i,t.color)},color:function(t,e,i,a){e!="inherit"&&(t.color=this.__parseStyle(e,!1,i,t.color))},"stop-color":function(t,e,i,a){e=="none"?t[1]=[0,0,0,0]:t[1]=this.__parseStyle(e,t[1],i,t.color)},"fill-opacity":function(t,e){t.fillOpacity=Math.min(1,Math.max(0,parseFloat(e)))},"stroke-opacity":function(t,e){t.strokeOpacity=Math.min(1,Math.max(0,parseFloat(e)))},"stop-opacity":function(t,e){t[1]=t[1]||[0,0,0],t[1][3]=Math.min(1,Math.max(0,parseFloat(e)))},"text-anchor":function(t,e){t.textAnchor=e,t.setAlign&&(e=="middle"?t.setAlign("center"):t.setAlign(e))},"font-family":function(t,e){t.fontFamily=e},"font-size":function(t,e){t.fontSize=this.parseUnit(e,t)},__parseStyle:function(t,e,i,a){if(t.charAt(0)=="#"){t.length==4&&(t=t.replace(/([^#])/g,"$1$1"));var n=t.slice(1).match(/../g).map(function(o){return parseInt(o,16)});return n}else if(t.search(/^rgb\(/)!=-1){for(var n=t.slice(4,-1).split(","),s=0;s<n.length;s++){var r=n[s].strip();r.charAt(r.length-1)=="%"?n[s]=Math.round(parseFloat(r.slice(0,-1))*2.55):n[s]=parseInt(r)}return n}else if(t.search(/^rgba\(/)!=-1){for(var n=t.slice(5,-1).split(","),s=0;s<3;s++){var r=n[s].strip();r.charAt(r.length-1)=="%"?n[s]=Math.round(parseFloat(r.slice(0,-1))*2.55):n[s]=parseInt(r)}var r=n[3].strip();return r.charAt(r.length-1)=="%"?n[3]=Math.round(parseFloat(r.slice(0,-1))*.01):n[3]=Math.max(0,Math.min(1,parseFloat(r))),n}else if(t.search(/^url\(/)!=-1){var h=t.match(/\([^)]+\)/)[0].slice(1,-1).replace(/^#/,"");return i[h]?i[h]:"rgba(255,0,255,1)"}else return t=="currentColor"?a:t=="none"?"none":t=="freeze"||t=="remove"?null:t}}};Object.toSource=function(t,e,i){e==null&&(e=0),i||(i="  ");for(var a="",n=0;n<e;n++)a+=i;var s;if(t==null)s="null";else if(typeof t=="function")s=Object.prettyFunctionString(t.toString()).replace(/\n/g,`
`+a);else if(typeof t=="string")s=t.escape();else if(t instanceof Array){var r=t.map(function(l){return Object.toSource(l)});if(r.join(", ").length<80)s="[ "+r.join(", ")+" ]";else{var r=t.map(function(f){return Object.toSource(f,e+1)});s=`[
`+r.join(`,
`)+`
`+a+"]"}}else if(typeof t=="object"){var h=[];for(var n in t){n.search(/^[a-zA-Z0-9]+$/)!=-1?name=a+i+n:name=Object.toSource(n,e+1);var o=name+" : "+Object.toSource(t[n],e+1).strip();typeof t[n]=="function"&&(o=`
`+o),h.push(o)}s=`{
`+h.join(`,
`)+`
`+a+"}"}else s=t.toString();return a+s};Object.prettyFunctionString=function(t){for(var e=t.replace(/\n\s+/g,`
`),i="",a=!1,n=!1,s=0;s<e.length;s++){var r=e[s];if(r=='"')a=!a;else if(a&&r=="\\")s++;else if(!a){if(r=="(")n=e.slice(s-4,s-1)=="for",i+="  ";else if(r==")")e[s-i.length-1]==`
`&&(e=e.splice(s-2,2,""),s-=2),i=i.slice(2);else if(r=="[")i+="  ";else if(r=="]")i=i.slice(2);else if(r=="{"&&e[s-1]!="\\")n=!1,i+="  ",e=e.splice(s+1,0,`
`+i),s+=i.length+1;else if(r=="}"&&e[s-1]!="\\")e[s-i.length-1]==`
`?(e=e.splice(s-2,2,""),s-=2):e[s-1]==" "?(e=e.splice(s-1,1,""),s-=1):(e=e.splice(s,0,`
`+i.slice(2)),s+=i.length-1),i=i.slice(2),e[s+1]!=";"&&e.slice(s+1).search(/^\s+else\s+/)==-1&&(e=e.splice(s+1,0,`
`+i),s+=i.length+1);else if(r==";"){if(!n){var h=e.slice(s+1).search(/\S/);h>0&&(e=e.splice(s+1,h,"")),e=e.splice(s+1,0,`
`+i),s+=i.length+1}}else if(r==`
`)e=e.splice(s+1,0,i),s+=i.length;else if(r==","&&e.slice(s).search(/^,\s+\S+:\s/)!=-1){var h=e.slice(s+1).search(/\S/);h>0&&(e=e.splice(s+1,h,"")),e=e.splice(s+1,0,`
`+i),s+=i.length+1}}}return e.replace(/\n+(\s+\n+)?/g,`
`)};window.GuiConfig=Klass({object:null,container:null,controls:null,title:null,description:null,initialize:function(t){if(Object.extend(this,t),this.container||(this.container=document.body),!this.controls)throw"You need to provide a list of controls.";this.element=E("div"),this.element.className="GuiConfig",this.title&&this.element.appendChild(E("h3",this.title,{className:"GuiConfigTitle"})),this.description&&this.element.appendChild(E("div",this.description,{className:"GuiConfigDescription"})),this.createControls()},createControls:function(){for(var t=0;t<this.controls.length;t++){var e=this.controls[t];if(typeof e=="object"&&e.length!=null)var i=this.parseType(e[0],e[1],e[2]);else if(typeof e=="string")var a=this.guessObjectType(this.object[e]),i=this.parseType(e,a,null);else throw"Unsupported control object type: "+e;var n=GuiConfig.widgets[i.type].apply(GuiConfig.widgets,i.arguments);this.element.appendChild(n)}},guessObjectType:function(t){var e=typeof t;return e},parseType:function(t,e,i){var a={varName:t,methodName:this.parseMethodName(t),object:this,title:this.parseTitle(t)};i&&Object.extend(a,i);var n=e;if(typeof e=="string"){if(e.match(/\.\./)){var s=e.split(".."),r=s[0],h=s[1],o=/[-+]?\d+(\.\d+)?/;r.match(o)&&h.match(o)&&(r.match(/\./)||h.match(/\./)?(n="float",a.values=[parseFloat(r),parseFloat(h)]):(n="int",a.values=[parseInt(r),parseInt(h)]))}}else typeof e=="object"&&e.length&&(n="array",a.values=e);return{type:n,arguments:[a]}},parseTitle:function(t){for(var e=t.split(/(?=[A-Z])/),i=1;i<e.length;i++)e[i]=e[i].toLowerCase();return e[0]=e[0].capitalize(),e.join(" ")},parseMethodName:function(t){return"set"+t.capitalize()},show:function(){this.container&&this.container.appendChild(this.element)},hide:function(){this.element.parentNode&&this.element.parentNode.removeChild(this.element)}});GuiConfig.widgets={__setValue:function(t,e,i,a){t.object&&(t.object[e]?t.object[e](a):t.object[i]=a)},function:function(t){var e=t.object,i=t.varName,a=t.title,n=E("p"),s=E("input",{type:"submit",value:a});return n.appendChild(s),s.onclick=function(r){return r.preventDefault&&r.preventDefault(),e.object[i](),!1},n},array:function(t){var e=t.object,i=t.methodName,a=t.varName,n=e.object&&e.object[a],s=t.title,r=E("p"),h=E("span",s);h.style.marginBottom="4px";for(var o=E("select"),l=0;l<t.values.length;l++){var f=E("option",{value:t.values[l],content:t.values[l],selected:n==t.values[l]});o.appendChild(f)}return r.appendChild(h),r.appendChild(E("br")),r.appendChild(o),o.onchange=function(){GuiConfig.widgets.__setValue(e,i,a,this.value)},r},boolean:function(t){var e=t.object,i=t.methodName,a=t.varName,n=t.title,s=E("p"),r=E("input",{type:"checkbox"});return s.appendChild(r),s.appendChild(E("span",n)),r.onchange=function(){GuiConfig.widgets.__setValue(e,i,a,this.checked)},e.object&&(r.checked=e.object[a]),s},float:function(t){var e=t.values[0],i=t.values[1];return this.slider(function(a){return(1-a)*e+a*i},t)},int:function(t){var e=t.values[0],i=t.values[1];return this.slider(function(a){return parseInt((1-a)*e+a*i)},t)},slider:function(t,e){var i=e.object,a=e.methodName,n=e.varName,s=e.title,r=E("p"),h=E.canvas(200,10);r.appendChild(h),r.appendChild(E("span",s));var o=new Canvas(h,{redrawOnlyWhenChanged:!0}),l=new CanvasNode,f=new Rectangle(196,2);f.x=2,f.y=4,f.stroke="rgba(0,0,0,0.5)",f.fill="rgba(255,255,255,0.5)";var u=new Rectangle(20,10);u.x=178,u.y=0,u.zIndex=2,u.stroke="rgba(0,0,0,0.5)",u.fill="rgba(255,255,255,0.5)",l.append(f,u);var c,d=1,g=!1;h.addEventListener("mousedown",function(p){var w=Mouse.getRelativeCoords(this,p);c=w.x,g=!0,d=(c-12)/176,d=Math.min(1,Math.max(0,d)),u.x=d*176+2;var S=t(d);GuiConfig.widgets.__setValue(i,a,n,S),o.changed=!0},!1),h.addEventListener("mousemove",function(p){var w=Mouse.getRelativeCoords(this,p);if(g&&c!=null){var S=w.x-c,b=S/176;d=Math.min(1,Math.max(0,d+b)),u.x=d*176+2;var P=t(d);GuiConfig.widgets.__setValue(i,a,n,P),o.changed=!0}c=w.x},!1);var m=function(p){g=!1};return window.addEventListener("mouseup",m,!1),h.addEventListener("DOMNodeRemovedFromDocument",function(){window.removeEventListener("mouseup",m,!1)},!1),o.append(l),r}};const M={rotation:function(t){return CanvasSupport.tRotationMatrix(t)},scaling:function(t,e){return CanvasSupport.tScalingMatrix(t,e)},translation:function(t,e){return CanvasSupport.tTranslationMatrix(t,e)}},V={rotate:function(t,e){return V.multiply(t,M.rotation(e))},add:function(t,e){return[e[0]+t[0],e[1]+t[1]]},multiply:function(t,e){return CanvasSupport.tMatrixMultiplyPoint(e,t[0],t[1])}},Formation=Klass({initialize:function(){this.ships=[];for(var t=0;t<arguments.length;t++)this.ships.push(arguments[t])},addShip:function(t){this.ships.indexOf(t)==-1&&this.ships.push(t)},removeShip:function(t){this.ships.deleteFirst(t)},formationFunction:function(t){return t.map(function(e,i,a){return[-70*(i/3),70*(i%3)]})},setWaypoint:function(t,e){for(var i=this.formationFunction(this.ships),a=0;a<i.length;a++){var n=i[a],s=this.ships[a],r=V.add(t,V.rotate(n,e));s.waypoint={x:r[0],y:r[1],rotation:e}}}}),Player$1=function(t,e){this.target=Player$1.targets[this.id];var i=this;if(Player$1.useTargettingAI&&(!Player$1.targets[this.id]||this.target.health<=0)&&(!this.target||this.target.health<=0||Math.random()<.3&&this.distanceTo(this.target)>this.weapon.range)&&(this.target=this.enemies.sort(function(o,l){return Math.abs(i.weapon.optimalRange-i.distanceTo(o))-Math.abs(i.weapon.optimalRange-i.distanceTo(l))})[0]),this.movementMode||(this.movementMode="normal"),Player$1.useMovementAI&&this.movementMode!="manual"&&!this.waypoint&&this.target&&this.target.health>0){var a=this.angleTo(this.target),n=this.distanceTo(this.target),s=n<this.weapon.range,r=n<this.weapon.optimalRange,h=this.target.weapon&&n<this.target.weapon.range;this.movementMode!="defensive"&&(this.movementMode=="aggressive"||Player$1.targets[this.id]==this.target)&&(this.turnToward(a),s&&this.turnToward(a+Math.PI/6),r&&this.turnToward(a+Math.PI),this.moveAt(1)),s&&!h&&(this.turnToward(a+Math.PI),this.moveAt(1))}};Player$1.useMovementAI=!0;Player$1.useTargettingAI=!0;Player$1.targets={};Player$1.selection=[];Player$1.toggleSelect=function(t){this.selection.indexOf(t.id)==-1?this.select(t):this.deselect(t)};Player$1.clearSelection=function(){for(this.selection.dict;this.selection.length>0;)this.deselect(this.selection.dict[this.selection[0]])};Player$1.select=function(t){this.selection.dict||(this.selection.dict={}),this.selection.formation||(this.selection.formation=new Formation),t.root.dispatchEvent({type:"select",canvasTarget:t}),this.selection.dict[t.id]=t,this.selection.formation.addShip(t),this.selection.push(t.id)};Player$1.deselect=function(t){this.selection.dict||(this.selection.dict={}),this.selection.formation||(this.selection.formation=new Formation),t.root.dispatchEvent({type:"deselect",canvasTarget:t}),delete this.selection.dict[t.id],this.selection.formation.removeShip(t),this.selection.deleteFirst(t.id)};Player$1.setWaypoint=function(t){this.selection.formation||(this.selection.formation=new Formation);var e=this.getSelectionCenter(),i=Curves.lineAngle(e,t);this.selection.formation.setWaypoint(t,i)};Player$1.getSelectionCenter=function(){for(var t=0,e=0,i=0;i<this.selection.length;i++){var a=this.selection.dict[this.selection[i]];t+=a.x,e+=a.y}return[t/this.selection.length,e/this.selection.length]};Player$1.setTarget=function(t){this.selection.forEach(function(e){Player$1.useMovementAI&&delete Player$1.selection.dict[e].waypoint,Player$1.targets[e]=t})};const ControlledNode=Klass(CanvasNode,{rotation:0,targetAngle:0,sinceLastTick:0,catchMouse:!1,turningSpeed:1,movementSpeed:20,moveSpeedFactor:0,frame:0,id:0,initialize:function(){this.id=ControlledNode.id++,CanvasNode.initialize.apply(this,arguments),this.addFrameListener(this.callAI),this.addFrameListener(this.updatePosition),this.addFrameListener(this.updateHealth)},callAI:function(t,e){this.root&&(e&&!isNaN(e)&&(this.sinceLastTick+=e),this.tick=this.sinceLastTick>=this.root.frameDuration,this.tick&&(this.sinceLastTick=0)),this.tick&&(this.frame%10==0&&(this.frame==0&&(this.frame+=Math.floor(Math.random()*10)),this.moveSpeedFactor=0,this.targetAngle=this.rotation,this.ai(t,e)),this.hitDetect(t,e),this.frame++)},ai:function(t,e){},hitDetect:function(t,e){},predictAngleToTarget:function(t){var e=Math.cos(this.target.rotation),i=Math.sin(this.target.rotation),a=this.target.movementSpeed*this.target.moveSpeedFactor,n=[e*a,i*a],s=this.target.x-this.x,r=this.target.y-this.y,h=s*s+r*r,o=2*s*n[0]+2*r*n[1],l=n[0]*n[0]+n[1]*n[1]-t*t,f=o*o-4*h*l;if(f<0)return this.angleTo(this.target);var u=2*h/(-o+Math.sqrt(f)),c=[this.target.x+n[0]*u,this.target.y+n[1]*u];return Math.atan2(c[1]-this.y,c[0]-this.x)},turnToward:function(t){this.targetAngle=t},moveAt:function(t){this.moveSpeedFactor=Math.min(1,Math.max(-1,t))},updateHealth:function(t,e){this.healthBar&&(this.healthBar.width=Math.max(0,parseInt(this.health/2.5)),this.healthBar.opacity=this.opacity,this.healthBar.x=this.x,this.healthBar.y=this.y)},updatePosition:function(t,e){var i=Curves.angularDistance(this.rotation,this.targetAngle);i>0?i=Math.min(i,this.turningSpeed*(e/1e3)):i=Math.max(i,-this.turningSpeed*(e/1e3)),this.rotation+=i;var a=Math.cos(this.rotation),n=Math.sin(this.rotation);this.x+=a*this.movementSpeed*this.moveSpeedFactor*(e/1e3),this.y+=n*this.movementSpeed*this.moveSpeedFactor*(e/1e3)}}),Explosion=Klass(CanvasNode,{catchMouse:!1,cursor:"default",circleGradient:new Gradient({type:"radial",endRadius:15,colorStops:[[0,"rgba(190,105,90,1)"],[.25,"rgba(5,30,80,0.4)"],[1,"rgba(10,0,40,0)"]]}),initialize:function(t){CanvasNode.initialize.call(this);var e=new Circle(15);e.fill=this.circleGradient,e.compositeOperation="lighter",this.zIndex=10,this.main=e,this.append(e),this.size=t,this.addFrameListener(this.blowup),this.after(500,this.removeSelf)},blowup:function(t,e){this.startTime==null&&(this.startTime=t);var i=Math.min(500,t-this.startTime),a=.48*.004*Math.PI;this.main.scale=1+this.size*(Explosion.fastExplosions?1:Math.tan(i*a)),isNaN(this.main.scale)&&(this.main.scale=6e4)}}),Projectile=Klass(ControlledNode,{zIndex:2,catchMouse:!1,initialize:function(t,e,i,a,n){this.targetingFunction=this.angleTo,Object.extend(this,e),ControlledNode.initialize.call(this),this.elapsed=0,this.owner=e,this.target=t,this.x=i,this.y=a,this.rotation=n,this.model=new Rectangle(this.movementSpeed/16,this.height,{centered:!0}),this.append(this.model),this.fill=this.color,this.projectileHealth&&(this.health=this.projectileHealth),this.maxHealth=this.health,this.initAI()},selfDestruct:function(){if(this.parent){var t=new Explosion(this.maxHealth*.01);return t.x=this.x,t.y=this.y,this.parent.append(t),this.removeSelf(),!1}},ai:function(t,e){if(this.target){var i=this.targetingFunction(this.target);this.turnToward(i),this.moveAt(1)}},hitDetect:function(t,e){var i=this.target.health>0;if(this.elapsed+=e,!!this.target){var a=this.distanceTo(this.target);return a<this.hitRadius&&this.hit(),i&&this.target.health<=0&&this.owner.gainExp(this.target),this.health<=0?this.selfDestruct():!0}},hit:function(){this.target.health-=this.damage,this.health-=this.hitDamageToSelf;var t=new Explosion(this.damage*.01);t.x=this.x,t.y=this.y,this.parent.append(t)}}),Weapon=Klass(CanvasNode,{catchMouse:!1,movementSpeed:100,turningSpeed:1,health:20,projectileHealth:1,hitDamageToSelf:1,range:200,optimalRange:100,reloadTime:1e3,salvos:5,techLevel:0,rotation:0,height:2,color:"white",x:0,y:0,rotation:0,projectile:Projectile,readyToFire:!0,initialize:function(t){CanvasNode.initialize.call(this),this.freeSalvos=this.salvos,t&&(this.techLevel=t)},gainExp:function(t){var e=t.techLevel;t.weapon?e=t.weapon.techLevel:t.damage&&(e*=.02*Math.max(1,t.damage))},fireAt:function(t){if(this.freeSalvos<1)return!1;this.freeSalvos--,this.rx=this.x+this.ship.x,this.ry=this.y+this.ship.y,this.rrot=this.rotation+this.ship.rotation;var e=this.createProjectile(t);this.ship.parent.append(e),this.after(this.reloadTime,this.reload),this.readyToFire=this.freeSalvos>0},reload:function(){this.freeSalvos++,this.readyToFire=this.freeSalvos>0},createProjectile:function(t){return new this.projectile(t,this,this.rx,this.ry,this.rrot)}}),RapidFireRailgun=Klass(Weapon,{isMissile:!0,movementSpeed:500,turningSpeed:0,projectileHealth:1,hitRadius:10,damage:100,range:500,optimalRange:250,reloadTime:200,salvos:1,color:"#5533ff",height:2,damageType:"kinetic",initAI:function(){this.rotation=this.predictAngleToTarget(this.movementSpeed),this.reloadTime*=Math.pow(.8,this.techLevel),this.movementSpeed*=Math.pow(1.1,this.techLevel),this.hitRadius*=Math.pow(1.1,this.techLevel),this.range*=Math.pow(1.1,this.techLevel),this.after(1e3,this.removeSelf);var t=new CanvasNode({stroke:"#ba88ba",x:this.x,y:this.y,rotation:this.rotation}),e=40+Math.random()*10;t.append(new Circle(5,{x:e,scale:[.2,1]})),t.animate("opacity",.7,0,300,"sqrt"),t.childNodes[0].animateTo("x",e-this.movementSpeed*.01,300,"sqrt"),t.childNodes[0].animateToFactor("scale",1+this.movementSpeed*(.004+Math.random()*.003),300,"sqrt"),t.after(300,t.removeSelf),this.afterFrame(1,function(){this.parentNode&&this.parentNode.append(t)})},ai:function(t,e){this.moveAt(1)},hit:function(){Projectile.hit.apply(this,arguments);var t=Math.max(0,this.movementSpeed*this.moveSpeedFactor*(.5+.5*Math.random())),e=new CanvasNode({x:this.x,y:this.y,rotation:this.rotation});e.after(300,e.removeSelf),this.parent.append(e);var i=new Circle(6,{x:30,scale:[.2,1],strokeWidth:5,fill:"none",stroke:"#ba88ba"});t<=1&&(t=1),i.animateTo("x",30+t*.04,t*.4,"sqrt"),i.animateToFactor("radius",2+t*.005*Math.random()*2,t*.3,"sqrt"),i.animate("opacity",1,0,t*.4,"sqrt"),e.append(i)}}),Missiles=Klass(Weapon,{isMissile:!0,movementSpeed:160,turningSpeed:3,projectileHealth:1,hitRadius:10,damage:20,range:500,optimalRange:250,reloadTime:3e3,salvos:8,color:"#22ccff",height:1.5,damageType:"explosive",initAI:function(){this.model.width*=2,this.reloadTime*=Math.pow(.8,this.techLevel),this.turningSpeed*=Math.pow(1.1,this.techLevel),this.movementSpeed*=Math.pow(1.1,this.techLevel),this.damage*=Math.pow(1.25,this.techLevel),this.techLevel>=4&&(this.salvos+=2,this.targetingFunction=this.predictAngleTo),this.after(5e3,this.removeSelf)},predictAngleTo:function(t){return this.predictAngleToTarget(this.movementSpeed)},hitDetect:function(t,e){if(this.target){if(!Projectile.hitDetect.apply(this,arguments))return!1;this.movementSpeed+=e*.06;var i=this.distanceTo(this.target);if(i<75){if(this.techLevel>=3){var a=this.targetingFunction(this.target);this.turnToward(a)}}else i<150&&this.techLevel>=3&&(this.targetAngle+=(Math.random()-.5)*.4*Math.max(1,i)*.01)}},hit:function(){if(Projectile.hit.apply(this,arguments),!Explosion.fastExplosions){var t=new Circle(Math.random()*4+this.damage*.18,{rotation:this.rotation,x:this.x,y:this.y,strokeWidth:1.5,scale:[.5+Math.random()*.5,1],stroke:"#da88fa"});t.animate("opacity",.8,0,400,"sqrt"),t.animateToFactor("scale",5,400,"sqrt"),t.after(400,t.removeSelf),this.parent.append(t)}}}),Beam$1=Klass(Weapon,{movementSpeed:200,turningSpeed:6,health:1,range:200,optimalRange:50,reloadTime:500,hitRadius:6,damage:15,salvos:5,color:"#cc44ff",sdTime:1250,height:1,isMissile:!0,damageType:"electric",initAI:function(){this.after(this.sdTime,this.removeSelf),this.range*=Math.pow(1.1,this.techLevel),this.movementSpeed*=Math.pow(1.1,this.techLevel),this.reloadTime*=Math.pow(.9,this.techLevel),this.damage*=Math.pow(1.1,this.techLevel),this.techLevel>=1&&(this.turningSpeed*=1.5),this.techLevel>=2&&(this.hitRadius*=1.5),this.techLevel>=3?(this.range*=1.25,this.rotation=this.predictAngleToTarget(this.movementSpeed)):this.rotation=this.angleTo(this.target),this.techLevel>=4&&(this.damage*=1.5,this.turningSpeed*=1.5),this.rotation+=.5*(Math.random()-.5)},ai:function(t,e){var i=this.angleTo(this.target),a=this.distanceTo(this.target);if(this.turnToward(i),this.moveAt(1),a<100&&this.target.health>0&&Math.random()<.5){var n=this.sdTime-this.elapsed-250;if(n>0){var s=new Projectile(this.target,this,this.x,this.y,this.rotation);s.sdTime=n,s.after(s.sdTime,s.removeSelf),s.rotation+=Math.random()*2-1,this.parentNode.append(s)}}},hitDetect:function(t,e){if(Beam$1.fastBeams&&this.target.health<=0)return this.removeSelf();Projectile.hitDetect.apply(this,arguments)},hit:function(){var t=10*(1-this.elapsed/(this.sdTime+1));if(this.target.health-=this.damage+t,this.health=0,!Beam$1.fastBeams){var e=Math.max(0,this.damage+t);e>this.target.maxHealth&&(e=this.target.maxHealth);var i=new Circle(Math.random()*5+e*.1,{rotation:this.rotation,x:this.x,y:this.y,strokeWidth:1,scale:1,compositeOperation:"lighter",stroke:"#a500a5"});i.animate("opacity",.8,0,300,"sqrt"),i.animateToFactor("scale",5,300,"sqrt"),i.after(300,i.removeSelf),this.parent.append(i)}}}),Railgun=Klass(Weapon,{isMissile:!0,movementSpeed:550,turningSpeed:.2,projectileHealth:5,range:600,optimalRange:400,reloadTime:4e3,salvos:1,color:"orange",hitRadius:10,damageType:"kinetic",initAI:function(){var t=Math.cos(this.ship.rotation),e=Math.sin(this.ship.rotation);this.x+=t*4,this.y+=e*4,this.rotation=this.predictAngleToTarget(this.movementSpeed)+(Math.random()-.5)*.2*(1/(1+this.techLevel)),this.techLevel>=1&&(this.movementSpeed+=50,this.reloadTime*=.75),this.techLevel>=2&&(this.turningSpeed*=1.5),this.techLevel>=3&&(this.movementSpeed*=1.2,this.hitRadius*=1.2,this.range*=1.2),this.techLevel>=4&&(this.movementSpeed*=1.3,this.hitRadius*=1.3,this.range*=1.4,this.reloadTime*=.66);var i=new CanvasNode({scale:[.2,.8],stroke:"#ba88ba",strokeWidth:2,x:this.x,y:this.y,rotation:this.rotation});i.append(new Circle(30,{x:60}));var a=400;i.animateToFactor("scale",1.4+this.movementSpeed*.001,a,"sqrt"),i.animate("opacity",1,0,a,"sqrt"),i.after(a,i.removeSelf);var n=new CanvasNode({fill:"#ba88ba",x:this.x,y:this.y,rotation:this.rotation});n.append(new Rectangle(this.movementSpeed/40,2,{centered:!0})),n.animate("opacity",1,0,600,"sqrt"),n.childNodes[0].animateTo("x",-this.movementSpeed*.1,600,"sqrt"),n.after(600,n.removeSelf),this.afterFrame(1,function(){this.parentNode.append(i),this.parentNode.append(n)}),this.after(3e3,this.removeSelf)},ai:function(t,e){this.moveAt(1-Math.sqrt(this.elapsed/6e3));var i=this.predictAngleToTarget(this.movementSpeed*this.moveSpeedFactor);this.turnToward(i)},hit:function(){var t=Math.max(0,this.movementSpeed*this.moveSpeedFactor),e=new CanvasNode({x:this.x,y:this.y,rotation:this.rotation});e.after(300,e.removeSelf),this.parent.append(e),this.rotation+=(Math.random()-.5)*(1-t*.0015),this.elapsed+=500;var i=Math.abs(t*.5);this.target.health-=i;var a=new Explosion(.25);if(a.x=this.x,a.y=this.y,this.parent.append(a),this.fill="darkred",this.health-=2,this.model.height=1,!this.hasHit){var n=new Circle(10,{x:30,scale:[.2,1],strokeWidth:5,fill:"none",stroke:"#ba88ba"});t<=1&&(t=1),n.animateTo("x",30+t*.03,300,"sqrt"),n.animateToFactor("radius",2+t*.005,300,"sqrt"),n.animate("opacity",1,0,300,"sqrt"),e.append(n)}this.hasHit=!0}}),PointDefenseMissiles=Klass(Weapon,{movementSpeed:250,turningSpeed:3,health:1,range:250,optimalRange:30,reloadTime:500,damage:4,hitRadius:9,height:1,salvos:2,color:"#dd2222",damageType:"explosive",initAI:function(){this.rotation=this.predictAngleToTarget(this.movementSpeed)+(Math.random()-.5),this.reloadTime*=Math.pow(.9,this.techLevel),this.turningSpeed*=Math.pow(1.2,this.techLevel),this.movementSpeed*=Math.pow(1.1,this.techLevel),this.after(1400,this.removeSelf)},ai:function(t,e){var i=this.angleTo(this.target);this.turnToward(i),this.moveAt(1-Math.sqrt(this.elapsed/6e3))},hit:function(){this.target.rotation+=Math.random()*.5-.25,this.target.movementSpeed*=1-2/this.target.health,this.target.health-=this.damage,this.health=0}}),PointDefenseGun=Klass(Weapon,{movementSpeed:450,turningSpeed:0,health:1,range:150,height:1,optimalRange:30,reloadTime:20,hitRadius:5,damage:2,salvos:2,color:"#dd2222",damageType:"kinetic",initAI:function(){this.x+=Math.cos(this.ship.rotation)*20,this.y+=Math.sin(this.ship.rotation)*20,this.model.width=4,this.hitRadius+=this.techLevel,this.techLevel>=2?this.rotation=this.predictAngleToTarget(this.movementSpeed):this.rotation=this.angleTo(this.target),this.after(600,this.removeSelf)},ai:function(t,e){this.moveAt(1-Math.sqrt(this.elapsed/1200))},hit:function(){this.target.rotation+=Math.random()*.5-.25,this.target.movementSpeed*=1-1/this.target.health,this.target.health-=this.damage,this.health=0}}),Ship=Klass(ControlledNode,{isShip:!0,target:null,health:100,catchMouse:!0,turningSpeed:1,movementSpeed:40,z:0,initialize:function(t,e,i,a,n,s,r){ControlledNode.initialize.call(this),this.zIndex=0+.001*(Ship.z++%1e3),this.stroke=t,this.team=t,this.weapon=e,this.weapon.ship=this,this.pointDefense=i,this.pointDefense.ship=this,this.x=a,this.y=n,r&&(this.health=r),this.rotation=Math.random()*Math.PI*2,this.model=new Polygon([20,0,-10,15,-10,-15]),this.model.strokeWidth=2,this.hardpoint=this.model.clone(),Object.extend(this.hardpoint,{scale:.2+this.weapon.techLevel*.1,centered:!0,stroke:!1,fill:this.weapon.color,weapon:this.weapon}),this.hardpoint.addFrameListener(function(){this.fill=this.weapon.color,this.scale=.2+this.weapon.techLevel*.1},!1),this.append(this.weapon),this.append(this.pointDefense),this.model.append(this.hardpoint),this.append(this.model),this.healthBar=new Rectangle(20,2,{fill:t,stroke:!1,centered:!0,cy:30}),this.selected=new Circle(35,{opacity:0}),this.targetMarker=new Rectangle(40,40,{rotation:Math.PI/4,centered:!0,stroke:this.stroke,visible:!1,opacity:.5,catchMouse:!1}),this.targetLine=new Line(0,0,0,0,{stroke:this.stroke,visible:!1,opacity:.5,catchMouse:!1}),this.waypointLine=new Line(0,0,0,0,{stroke:"#448866",visible:!1,opacity:.5,catchMouse:!1}),this.append(this.selected),this.maxHealth||(this.maxHealth=this.health),this.addEventListener("mousedown",function(h){this.strategicAI==Player$1?(h.shiftKey||Player$1.clearSelection(),Player$1.toggleSelect(this)):Player$1.setTarget(this)},!1),this.addEventListener("select",function(h){this.selected.opacity=.5,this.waypointLine.opacity=.5,this.targetLine.opacity=.5},!1),this.addEventListener("deselect",function(h){this.selected.opacity=0,this.waypointLine.opacity=.15,this.targetLine.opacity=.1},!1),s||this.warpIn()},warpIn:function(){this.opacity=0,this.aiDisabled=!0,this.warpModel=new Spiral(0,{stroke:"blue",zIndex:-1}),this.warpModel.animateTo("endAngle",40,500,"square"),this.warpModel.after(500,function(){this.animateTo("endAngle",0,500,"square"),this.after(500,this.removeSelf)}),this.animateTo("opacity",1,1e3,"sine"),this.model.animate("rotation",-10,0,1e3,"sqrt"),this.after(1e3,function(){this.aiDisabled=!1})},tacticalAI:function(t,e){if(!this.aiDisabled){var i=this.parentNode.childNodes,a=this,n=[];if(this.pointDefense.readyToFire){var s=i.filter(function(u){return u.isMissile}),r=s.filter(function(u){return u.target.team==a.team}).sort(function(u,c){return a.pointDefense.optimalRange-Math.abs(a.distanceTo(u)-a.distanceTo(c))}),h=r.filter(function(u){return u.target==a}).sort(function(u,c){return Math.abs(a.pointDefense.optimalRange-a.distanceTo(u))-Math.abs(a.pointDefense.optimalRange-a.distanceTo(c))}),n=h.concat(r).concat(this.enemies).filter(function(u){return(!u.target||u.target.health>0)&&(u.isMissile?a.distanceTo(u)<a.pointDefense.range:a.distanceTo(u)<a.pointDefense.optimalRange)});this.intercept(n)}var o=this.target||n[0];if(o&&o.health>0){var l=this.distanceTo(o);l<this.weapon.range&&this.weapon.readyToFire&&Math.random()<.7&&this.fireAt(o)}this.waypoint&&(this.distanceTo(this.waypoint)<5?(this.moveAt(0),Math.abs(Curves.angularDistance(this.rotation,this.waypoint.rotation))<.1?delete this.waypoint:this.turnToward(this.waypoint.rotation)):(this.turnToward(this.angleTo(this.waypoint)),this.moveAt(this.distanceTo(this.waypoint)/this.movementSpeed)))}},strategicAI:function(t,e){if(!this.aiDisabled){var i=this;if((!this.target||this.target.health<=0||Math.random()<.3&&this.distanceTo(this.target)>this.weapon.range)&&(this.target=this.enemies.sort(function(s,r){return Math.abs(i.weapon.optimalRange-i.distanceTo(s))-Math.abs(i.weapon.optimalRange-i.distanceTo(r))})[0]),this.target&&this.target.health>0){var a=this.angleTo(this.target),n=this.distanceTo(this.target);n<this.weapon.range?this.turnToward(a+Math.PI/6):n>this.weapon.optimalRange?this.turnToward(a):Math.random()<.8&&this.turnToward(a+Math.PI/2),n<this.weapon.optimalRange&&this.turnToward(a+Math.PI*.85),this.moveAt(1)}}},hitDetect:function(t,e){ControlledNode.hitDetect.apply(this,arguments),this.health<=0?(Player$1.deselect(this),this.selected.opacity=0,this.targetLine.removeSelf(),this.targetMarker.removeSelf(),this.waypointLine.removeSelf(),this.healthBar.removeSelf()):(this.healthBar.parent!=this.parent&&this.parent.append(this.healthBar),this.strategicAI==Player$1?this.cursor=SELECT_CURSOR:Player$1.selection.length>0?this.cursor=TARGET_CURSOR:this.cursor=DEFAULT_CURSOR,this.healthBar.cursor=this.cursor,this.target&&this.target.health>0&&(this.strategicAI==Player$1||this.target.strategicAI==Player$1)?(this.targetMarker.parent||this.parent.append(this.targetMarker,this.targetLine),this.targetLine.x1=this.x,this.targetLine.y1=this.y,this.targetLine.x2=this.targetMarker.x=this.target.x,this.targetLine.y2=this.targetMarker.y=this.target.y,this.targetLine.visible=Player$1.targets[this.id]==this.target&&!this.waypoint,this.targetMarker.visible=!0):this.targetLine.visible=this.targetMarker.visible=!1,this.waypoint&&this.strategicAI==Player$1?(this.waypointLine.parent||this.parent.append(this.waypointLine),this.waypointLine.x1=this.x,this.waypointLine.y1=this.y,this.waypointLine.x2=this.waypoint.x,this.waypointLine.y2=this.waypoint.y,this.waypointLine.visible=!0):this.waypointLine.visible=!1)},ai:function(t,e){if((this.x<-50||this.y<-50||this.x>this.parent.width+50||this.y>this.parent.height+50)&&(this.health-=3),this.health>0){var i=this.parentNode.childNodes,a=this;this.enemies=i.filter(function(o){return o.isShip&&o.team!=a.team}),this.friends=i.filter(function(o){return o.isShip&&o.team==a.team}),this.strategicAI(t,e),this.tacticalAI(t,e)}else if(!this.blowup){var n=this.maxHealth/20*(1+.1*this.weapon.techLevel),s=new Explosion(.25*n+Math.random());s.x=this.x,s.y=this.y,this.parent.append(s);for(var r=n*.2+Math.random()*n,h=0;h<r;h++)this.parent.after(200+h*60*Math.random(),function(o){return function(){var l=new Explosion(Math.random()*n/5),f=Math.random();f*=f,f+=o/r,f*=Math.random()<.5?-1:1,l.x=s.x+f*5*n;var f=Math.random();f*=f,f+=o/r,f*=Math.random()<.5?-1:1,l.y=s.y+f*5*n,this.append(l)}}(h));this.root.dispatchEvent({type:"destroyed",canvasTarget:this}),this.removeSelf(),this.blowup=!0}},intercept:function(t){if(t.length!=0){for(var e=0,i=0;this.pointDefense.readyToFire;)if(this.pointDefense.fireAt(t[e]),e=(e+1)%t.length,e==0&&i++,i==1)return}},firedShots:0,fireAt:function(t){for(var e=0;e<this.weapon.salvos/4;e++)this.weapon.readyToFire&&(this.weapon.rotation=Math.PI*(this.firedShots%2-.5),this.weapon.fireAt(t),this.firedShots++)}}),Level=Klass(CanvasNode,{bgColor:"rgb(0,0,0)",bgOpacity:0,playerTeam:"#aa2222",enemyTeam:"#2266aa",initialize:function(){CanvasNode.initialize.call(this),this.ships={},this.bg=new Rectangle(this.width,this.height),this.bg.fill=this.bgColor,this.bg.fillOpacity=this.bgOpacity;var t,e,i,a=this,n=function(s){return a.childNodes.filter(function(r){var h=Math.min(s.cx,s.x2),o=Math.max(s.cx,s.x2),l=Math.min(s.cy,s.y2),f=Math.max(s.cy,s.y2);return r.isShip&&r.strategicAI==Player$1&&r.x>=h&&r.x<=o&&r.y>=l&&r.y<=f})};this.selectRect=new Rectangle(0,0,{stroke:1,strokeOpacity:.4,stroke:"#00ff00",fillOpacity:.1,fill:"#00ff00",visible:!1,zIndex:999}),this.append(this.selectRect),this.bg.addEventListener("mousedown",function(s){s.preventDefault();var r=CanvasSupport.tMatrixMultiplyPoint(CanvasSupport.tInvertMatrix(this.currentMatrix),this.root.mouseX,this.root.mouseY);e=this.root.mouseX,i=this.root.mouseY,t=r,a.selectRect.x2=a.selectRect.cx=r[0],a.selectRect.y2=a.selectRect.cy=r[1]},!1),this.bg.addEventListener("drag",function(s){var r=CanvasSupport.tMatrixMultiplyPoint(CanvasSupport.tInvertMatrix(this.currentMatrix),this.root.mouseX,this.root.mouseY);if(t&&!a.selectRect.visible){var h=e-this.root.mouseX,o=i-this.root.mouseY,l=h*h+o*o;a.selectRect.visible=l>81}a.selectRect.visible&&(a.selectRect.x2=r[0],a.selectRect.y2=r[1])},!1),this.mouseupHandler=function(s){var r=CanvasSupport.tMatrixMultiplyPoint(CanvasSupport.tInvertMatrix(a.currentMatrix),a.root.mouseX,a.root.mouseY);if(t&&a.selectRect.visible){a.selectRect.visible=!1,t=null;var h=n(a.selectRect);s.shiftKey?h.forEach(Player$1.select.bind(Player$1)):s.altKey?h.forEach(Player$1.deselect.bind(Player$1)):(Player$1.clearSelection(),h.forEach(Player$1.select.bind(Player$1)))}else t&&(s.canvasTarget==a.selectRect||s.canvasTarget==a.bg)&&(Player$1.setWaypoint(r),a.selectRect.visible=!1,t=null)},this.addEventListener("rootChanged",function(s){s.canvasTarget==this&&(this.root&&this.root.removeEventListener("mouseup",this.mouseupHandler,!1),s.relatedTarget.addEventListener("mouseup",this.mouseupHandler,!1))},!1),this.bg.zIndex=-100,this.messageLayer=new CanvasNode({zIndex:1e3,scale:1/this.scale}),this.append(this.bg,this.messageLayer),this.addFrameListener(function(){Player$1.selection.length>0?this.cursor=MOVE_TO_CURSOR:this.cursor=DEFAULT_CURSOR}),this.destroyedHandler=this.destroyed.bind(this),this.when("teamDestroyed",function(s){s.detail==this.enemyTeam?this.enemyTeamDestroyed(s.detail):s.detail==this.playerTeam&&this.gameOver()}),this.showDescription()},enemyTeamDestroyed:function(t){this.levelCompleted()},showDescription:function(){var t=E("div");t.appendChild(E("h1",this.name)),t.appendChild(E("div",this.description)),this.query(t,"Start level",function(){this.root.dispatchEvent({type:"started",canvasTarget:this})},"Back to main menu",function(){this.parentNode.gameOver()})},query:function(t){var e=E("div",{className:"message"}),i=new ElementNode(e,{x:320,y:30,align:"center"}),a=E("div",t);e.appendChild(a);for(var n=E("div"),s=this,r=1;r<arguments.length;r+=2){var h=arguments[r],o=arguments[r+1];n.appendChild(E("h2",h,{onclick:function(l){return function(){this.clicked||(l.call(s),this.clicked=!0,i.after(500,i.removeSelf),i.animateTo("opacity",0,500,"sine"))}}(o),style:{cursor:"pointer"}}))}e.appendChild(n),i.opacity=0,i.animateTo("opacity",1,500,"sine"),this.messageLayer.append(i)},notify:function(t,e,i){e||(e=0),this.after(e,function(){var a=new ElementNode(E("h3",t),{x:320,y:30,align:"center"});i||(i=3500+a.element.textContent.length*10),a.opacity=0,a.animateTo("opacity",1,500,"sine"),a.after(i,function(){this.animateTo("opacity",0,500,"sine")}),a.after(i+500,a.removeSelf),this.messageLayer.append(a)})},gameOver:function(){this.completed||(this.failed=!0,this.after(1e3,function(){this.query(E("h1","Your fleet was destroyed"),"Try again",function(){this.parentNode.tryAgain()},"Back to main menu",function(){this.parentNode.gameOver()})}))},levelCompleted:function(){this.failed||this.after(1e3,function(){this.failed||(this.completed=!0,this.query(E("h1","Level complete"),"Next level",function(){this.parentNode.nextLevel()},"Play again",function(){this.parentNode.tryAgain()},"Back to main menu",function(){this.parentNode.gameOver()}))})},createShip:function(t,e,i,a,n,s,r){this.ships[t]||(this.ships[t]=0);var h;if(i.length&&(i[1]&&(h=i[1]),i=i[0]),!h)switch(i){case Missiles:h=PointDefenseMissiles;break;case Beam$1:h=Beam$1;break;case RapidFireRailgun:h=RapidFireRailgun;break;default:h=PointDefenseGun}var o=new Ship(t,new i(e),new h(e),a,n,s,r);return t==this.playerTeam&&(o.strategicAI=Player$1),o.when("destroyed",this.destroyedHandler),this.ships[t]++,o},createGroup:function(t,e,i,a,n,s,r){var h=0,o=this,l=Math.PI*2/(n.length-1);return n.map(function(f){if(h==0)var u=0,c=0;else var d=h*l,g=Math.max(80,100/l),u=Math.cos(d)*g,c=Math.sin(d)*g;return h++,o.createShip(t,e,f,i+u,a+c,s,r)})},ship:function(){this.append(this.createShip.apply(this,arguments))},shipAfter:function(t,e,i,a,n,s,r,h){this.ships[e]||(this.ships[e]=0),this.ships[e]++,this.after(t,function(){this.ships[e]--,this.ship(e,i,a,n,s,r,h)})},group:function(t,e,i,a,n,s,r){this.append.apply(this,this.createGroup.apply(this,arguments))},groupAfter:function(t,e,i,a,n,s,r,h){this.ships[e]||(this.ships[e]=0),this.ships[e]+=s.length,this.after(t,function(){this.ships[e]-=s.length,this.group(e,i,a,n,s,r,h)})},destroyed:function(t){this.ships[t.canvasTarget.team]--,this.ships[t.canvasTarget.team]<1&&this.root.dispatchEvent({type:"teamDestroyed",detail:t.canvasTarget.team,canvasTarget:this})}}),Level1=Klass(Level,{width:640,height:480,scale:1,name:"Run like the wind",description:"Try not to get blown up.",initialize:function(){Level.initialize.call(this),this.when("started",function(){this.shipAfter(0,this.playerTeam,0,Missiles,100,100),this.shipAfter(5e3,this.enemyTeam,0,PointDefenseGun,680,300,!0),this.shipAfter(1e4,this.enemyTeam,0,PointDefenseMissiles,-40,220,!0),this.shipAfter(15e3,this.enemyTeam,0,[Beam$1,PointDefenseGun],400,520,!0)})}}),Level2=Klass(Level,{width:1280,height:960,scale:.5,name:"What doesn't hit you, can't hurt you",description:"Take care not to get overwhelmed.",initialize:function(){Level.initialize.call(this),this.when("started",function(){this.shipAfter(500,this.playerTeam,1,Beam$1,700,500),this.shipAfter(1e3,this.playerTeam,1,Beam$1,600,300),this.notify("Reinforcements are on the way",2e4),this.shipAfter(23e3,this.playerTeam,1,Beam$1,640,480),this.shipAfter(3e3,this.enemyTeam,0,Missiles,1320,800),this.shipAfter(17e3,this.enemyTeam,0,Missiles,1100,-40),this.shipAfter(32e3,this.enemyTeam,0,Missiles,810,1e3),this.shipAfter(6e3,this.enemyTeam,0,Missiles,-40,300),this.shipAfter(22e3,this.enemyTeam,0,Missiles,200,1e3),this.shipAfter(24e3,this.enemyTeam,0,PointDefenseGun,100,1e3)})}}),Level3=Klass(Level,{width:1280,height:960,scale:.5,name:"Formation",description:"It may be a bit tricky, luck helps.",initialize:function(){Level.initialize.call(this),this.when("started",function(){this.ship(this.playerTeam,2,Railgun,600,400),this.ship(this.playerTeam,0,Missiles,650,460),this.groupAfter(5e3,this.enemyTeam,1,400,-40,[Beam$1,Beam$1]),this.groupAfter(25e3,this.enemyTeam,0,-40,520,[Beam$1,Beam$1]),this.shipAfter(15e3,this.enemyTeam,3,Missiles,1310,1e3)})}}),Level4=Klass(Level,{name:"Against smaller numbers",description:"This should be easy, right?",reinforcementMessage:"Reinforcements are on the way.",width:1280,height:960,scale:.5,initialize:function(){Level.initialize.call(this),this.when("started",function(){this.group(this.enemyTeam,1,1e3,180,[Beam$1,Missiles,Railgun],!0),this.groupAfter(2500,this.playerTeam,1,200,800,[Missiles,PointDefenseMissiles,PointDefenseMissiles,PointDefenseGun,PointDefenseGun,PointDefenseGun]),this.notify(this.reinforcementMessage,17e3),this.groupAfter(2e4,this.playerTeam,1,200,800,[Beam$1,PointDefenseGun])})}}),Level5=Klass(Level,{name:"Not fair",description:"Well, that's life.",width:1280,height:960,scale:.5,initialize:function(){Level.initialize.call(this),this.when("started",function(){this.groupAfter(3e3,this.enemyTeam,1,this.width*.9,this.height*.85,[RapidFireRailgun,RapidFireRailgun,RapidFireRailgun]),this.group(this.playerTeam,4,200,200,[PointDefenseMissiles,PointDefenseGun,PointDefenseGun,PointDefenseGun,Missiles,Missiles,Missiles])})}}),Level6=Klass(Level,{name:"Ye Good Ole Slug-Out",description:"Tactics, schmactics.",width:1280,height:960,scale:.5,initialize:function(){Level.initialize.call(this),this.when("started",function(){this.group(this.enemyTeam,0,this.width*.9,this.height*.85,[Railgun,Railgun,Missiles,Beam$1,RapidFireRailgun]),this.group(this.playerTeam,0,this.width*.1,this.height*.15,[Railgun,Railgun,Missiles,Beam$1,RapidFireRailgun])})}}),Level7=Klass(Level,{name:"Missiles are awesome",description:"And make the computer slow doooown.",width:1600,height:1200,scale:640/1600,initialize:function(){Level.initialize.call(this),this.when("started",function(){this.group(this.playerTeam,2,this.width*.5,this.height*.15,[Missiles,Missiles,Missiles,Missiles,Missiles]);for(var t=1;t<=10;t++)this.groupAfter(t*3e3,this.enemyTeam,0,Math.random()*this.width,this.height+40,[Beam$1,Beam$1],!0)})}}),Level8=Klass(Level,{name:"Railguns are awesome too",description:"But take oh so long to reload.",width:1600,height:1200,scale:640/1600,initialize:function(){Level.initialize.call(this),this.when("started",function(){this.group(this.playerTeam,4,this.width*.2,this.height*.5,[Railgun,Railgun,Railgun,Railgun,Railgun,Railgun]);for(var t=1;t<=8;t++)this.groupAfter(t*3e3,this.enemyTeam,4,-100,Math.random()*this.height,[Missiles,Missiles],!0);this.groupAfter(9*3e3,this.enemyTeam,4,this.width*.5,this.height+50,[Missiles,Missiles],!0),this.groupAfter(10*3e3,this.enemyTeam,4,this.width*.5,-50,[Missiles,Missiles],!0)})}}),Level9=Klass(Level,{name:"Duels",description:"Cheese is awesome as well.",width:1600,height:1200,scale:640/1600,initialize:function(){Level.initialize.call(this),this.when("started",function(){for(var t=1;t<=10;t++)this.groupAfter(t*3e3-1500,this.playerTeam,4,this.width*.8,this.height*(.1+Math.random()*.8),[t<=6?RapidFireRailgun:PointDefenseGun]),this.groupAfter(t*3e3,this.enemyTeam,4,this.width*.2,this.height*Math.random(),[RapidFireRailgun])})}}),Level10=Klass(Level,{name:"Relaaax",description:"An intermission.",width:1600,height:1200,scale:640/1600,initialize:function(){Level.initialize.call(this),this.when("started",function(){this.group(this.playerTeam,5,this.width*.5,this.height*.5,[RapidFireRailgun,RapidFireRailgun,RapidFireRailgun]);for(var t=1;t<=3;t++)this.groupAfter(t*3e3,this.enemyTeam,2,this.width*Math.random(),this.height*Math.random(),[Railgun,PointDefenseMissiles,PointDefenseMissiles]);for(var t=5;t<=7;t++)this.groupAfter(t*3e3,this.enemyTeam,2,this.width*Math.random(),this.height*Math.random(),[Beam$1,PointDefenseMissiles,PointDefenseMissiles]);for(var t=9;t<=12;t++)this.groupAfter(t*3e3,this.enemyTeam,4,this.width*Math.random(),this.height*Math.random(),[Missiles,PointDefenseMissiles,PointDefenseMissiles]);this.groupAfter(15*3e3,this.enemyTeam,5,this.width*Math.random(),this.height*Math.random(),[Missiles,Missiles,Missiles,Missiles,Missiles,Missiles,Missiles])})}}),Level11=Klass(Level,{name:"Encounter",description:"Even fight.",width:2e3,height:1500,scale:640/2e3,initialize:function(){Level.initialize.call(this),this.when("started",function(){this.group(this.playerTeam,5,this.width*.2,this.height*.8,[Railgun,Railgun,Railgun,Missiles,Missiles,Missiles,Beam$1,Beam$1,Beam$1]),this.group(this.enemyTeam,5,this.width*.8,this.height*.2,[Railgun,Railgun,Railgun,Missiles,Missiles,Missiles,Beam$1,Beam$1,Beam$1])})}}),Level12=Klass(Level,{name:"Skirmish",description:"Take out the blue ships.",width:1600,height:1200,scale:640/1600,wave:20,initialize:function(){Level.initialize.call(this),this.when("started",function(){this.ships[this.playerTeam]=100,this.ships[this.enemyTeam]=100,this.newShips(),this.every(4e3,this.newShips)})},newShips:function(t){if(t||(t=0),this.wave--,this.wave==1)this.ships[this.playerTeam]-=100,this.ships[this.enemyTeam]-=100;else if(this.wave==0)return!1;var e=this.ships[this.playerTeam]||0,i=this.ships[this.enemyTeam]||0,a=new Array(Math.max(1,i-e)).map(this.randomWeapon),n=new Array(Math.max(1,e-i)).map(this.randomWeapon);this.groupAfter(t,this.playerTeam,Math.random()*6,this.width*(.2+Math.random()*.6),this.height*(.2+Math.random()*.6),a),this.groupAfter(t,this.enemyTeam,Math.random()*6,this.width*(.2+Math.random()*.6),this.height*(.2+Math.random()*.6),n)},weapons:[Beam$1,Missiles,Railgun],randomWeapon:function(){return Math.random()<.02?RapidFireRailgun:Level12.weapons.pick()}}),Level13=Klass(Level,{name:"Random encounter",description:"How will you cope?",width:1600,height:1200,scale:640/1600,initialize:function(){Level.initialize.call(this),this.when("started",function(){var t=Math.random()*6,e=3+Math.floor(Math.random()*7),i=new Array(e).map(Level12.randomWeapon),a=new Array(e).map(Level12.randomWeapon);this.group(this.playerTeam,t,this.width*.2,this.height*.8,i),this.group(this.enemyTeam,t,this.width*.8,this.height*.2,a)})}}),MenuLevel=Klass(Level,{width:1280,height:960,scale:.5,playerTeam:null,enemyTeam:null,initialize:function(){Level.initialize.call(this),this.menu=new CanvasNode,this.menu.scale=2,this.menu.zIndex=100,this.append(this.menu),this.setupMenu(),this.newShip(),this.every(4e3,this.newShip),this.selectRect.opacity=0},showDescription:function(){},newShip:function(){var t="#2266aa",e="#aa2222",i=this.childNodes.filter(function(s){return s.team==t}).length,a=this.childNodes.filter(function(s){return s.team==e}).length,n=1+Math.max(0,i-a);this.taskforce(e,Math.random()*this.width,Math.random()*this.height,n);var n=1+Math.max(0,a-i);this.taskforce(t,Math.random()*this.width,Math.random()*this.height,n)},taskforce:function(t,e,i,a){for(var n=[Missiles,Beam$1,Railgun],s=Math.random()*6,r=0;r<a;r++){var h=n[Math.floor(n.length*Math.random())],o=h==Missiles?PointDefenseMissiles:PointDefenseGun;h==Beam$1&&(o=Beam$1),Math.random()<.03&&(h=o=RapidFireRailgun);var l=new Ship(t,new h(s),new o(s),e+Math.random()*100-50,i+Math.random()*100-50);this.append(l)}},setupMenu:function(){var t=E("h1");t.appendChild(T("MISSILE FLEET"));var e=new ElementNode(t,{x:320,y:40,zIndex:1002,align:"center",cursor:"default"}),i=this,a=new CanvasNode,n=new ElementNode(E("div",{style:{width:"100vw",height:"100vh",marginTop:"-50vh",marginLeft:"-50vw",backgroundColor:this.bgColor,opacity:.5}}),{x:320,y:240,zIndex:1001});a.append(n),a.display="none",a.opacity=0;var s=E("ol");MissileFleet.levels.slice(1).forEach(function(f,u){var c=E("li",E("h3",u+1+". "+f.prototype.name));c.onclick=function(){i.clicked||(i.clicked=!0,i.menu.controls.animateTo("opacity",0,300,"sine"),i.after(300,function(){this.parentNode.jumpToLevel(MissileFleet.levels.indexOf(f))}))},c.style.cursor="pointer",s.appendChild(c)});var r=E("h2","JUMP TO LEVEL"),h=new ElementNode(r,{zIndex:1002,x:320,y:120,align:"center"}),o=new ElementNode(s,{zIndex:1002,x:320,y:164,align:"center"}),l=new Rectangle(540,1,{centered:!0,x:320,y:87.5,fill:"red"});a.append(h,o,l),this.menu.title=e,this.menu.controls=a,this.menu.append(e),this.menu.append(a),this.bg.addEventListener("click",function(){i.menuVisible||i.showMenu()},!1)},showMenu:function(){if(!this.menuVisible){this.menuVisible=!0;var t=this;this.menu.controls.display="block",this.menu.controls.animateTo("opacity",1,500,"sine"),this.menu.after(1e4,function(){this.controls.animateTo("opacity",0,500,"sine"),this.after(500,function(){this.controls.display="none",t.menuVisible=!1})})}}}),TouchControls={enabled:!1,lastTap:0,doubleTapDelay:300,isTouchDevice:function(){return"ontouchstart"in window||navigator.maxTouchPoints>0},init:function(t){this.isTouchDevice()&&(this.enabled=!0,this.canvas=t,t.addEventListener("touchstart",this.handleTouchStart.bind(this),{passive:!1}),t.addEventListener("touchmove",this.handleTouchMove.bind(this),{passive:!1}),t.addEventListener("touchend",this.handleTouchEnd.bind(this),{passive:!1}))},handleTouchStart:function(t){if(t.preventDefault(),t.touches.length===1){var e=t.touches[0],i=new MouseEvent("mousedown",{clientX:e.clientX,clientY:e.clientY,button:0,bubbles:!0});this.canvas.dispatchEvent(i),this.touchStartTime=Date.now()}},handleTouchMove:function(t){if(t.preventDefault(),t.touches.length===1){var e=t.touches[0],i=new MouseEvent("mousemove",{clientX:e.clientX,clientY:e.clientY,button:0,bubbles:!0});this.canvas.dispatchEvent(i);var a=new CustomEvent("drag",{bubbles:!0,detail:{clientX:e.clientX,clientY:e.clientY}});this.canvas.dispatchEvent(a)}},handleTouchEnd:function(t){t.preventDefault();var e=Date.now(),i=e-(this.touchStartTime||0);if(i<200&&e-this.lastTap<this.doubleTapDelay){Player.clearSelection(),this.lastTap=0;return}else i<200&&(this.lastTap=e);var a=new MouseEvent("mouseup",{clientX:t.changedTouches[0].clientX,clientY:t.changedTouches[0].clientY,button:0,bubbles:!0});this.canvas.dispatchEvent(a)}},FullscreenMode={isFullscreen:!1,init:function(t){this.canvas=t,this.createButtons(),this.setupFullscreenListeners()},createButtons:function(){var t=document.createElement("div");t.id="fullscreen-controls",t.style.cssText="position: fixed; z-index: 9999;";var e=document.createElement("button");e.id="fullscreen-btn",e.innerHTML="",e.title="Toggle Fullscreen",e.onclick=this.toggleFullscreen.bind(this);var i=document.createElement("button");i.id="info-btn",i.innerHTML="",i.title="Show Info",i.onclick=n=>{n.preventDefault(),document.getElementById("info-overlay").classList.remove("hidden")};var a=document.getElementById("close-info");a.onclick=n=>{n.preventDefault(),document.getElementById("info-overlay").classList.add("hidden")},t.appendChild(e),t.appendChild(i),document.body.appendChild(t)},toggleFullscreen:function(){var t=document.documentElement;this.isFullscreen?document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.msExitFullscreen&&document.msExitFullscreen():t.requestFullscreen?t.requestFullscreen():t.webkitRequestFullscreen?t.webkitRequestFullscreen():t.mozRequestFullScreen?t.mozRequestFullScreen():t.msRequestFullscreen&&t.msRequestFullscreen()},setupFullscreenListeners:function(){var t=this,e=function(){t.isFullscreen=!!(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement),t.isFullscreen?document.body.classList.add("fullscreen-mode"):document.body.classList.remove("fullscreen-mode")};document.addEventListener("fullscreenchange",e),document.addEventListener("webkitfullscreenchange",e),document.addEventListener("mozfullscreenchange",e),document.addEventListener("MSFullscreenChange",e)}},DEFAULT_CURSOR="default",MOVE_TO_CURSOR="url(moveto.png) 9 9, move",TARGET_CURSOR="crosshair",SELECT_CURSOR="pointer",MissileFleet=Klass(CanvasNode,{levelIndex:0,levels:[MenuLevel,Level1,Level2,Level3,Level4,Level5,Level6,Level7,Level8,Level9,Level10,Level11,Level13],bgColor:"rgb(0,0,0)",bgOpacity:.15,initialize:function(t){CanvasNode.initialize.call(this),this.canvas=new Canvas(t),this.canvas.frameDuration=30,this.canvas.append(this),this.canvas.fixedTimestep=!0,this.canvas.clear=!1,this.bg=new Rectangle(5e3,5e3),this.bg.fill=this.bgColor,this.bg.fillOpacity=this.bgOpacity,this.bg.x=-2500,this.bg.y=-2500,this.bg.z=-1,this.bg.catchMouse=!1,this.canvas.append(this.bg);const e=()=>{const i=window.innerWidth*devicePixelRatio,a=window.innerHeight*devicePixelRatio;t.width=i,t.height=a,this.canvas.scale=Math.min(i/640,a/480),this.canvas.x=(i-640*this.canvas.scale)/2,this.canvas.y=(a-480*this.canvas.scale)/2,i<a?(this.canvas.rotation=Math.PI/2,this.canvas.scale=Math.min(a/640,i/480),this.canvas.x=480*this.canvas.scale+(i-480*this.canvas.scale)/2,this.canvas.y=(a-640*this.canvas.scale)/2):this.canvas.rotation=0};e(),window.addEventListener("resize",e),this.gameOver(),this.setupEtc()},gameOver:function(){this.levelIndex=0,this.changeLevel(this.levels[this.levelIndex])},nextLevel:function(){this.levelIndex++;var t=this.levels[this.levelIndex%this.levels.length];this.changeLevel(t)},jumpToLevel:function(t){this.levelIndex=t;var e=this.levels[this.levelIndex%this.levels.length];this.changeLevel(e)},tryAgain:function(){this.changeLevel(this.levels[this.levelIndex])},changeLevel:function(t){Player$1.waypoints={},Player$1.targets={},Player$1.selection=[],this.level&&this.level.removeSelf(),t&&(this.level=new t,this.append(this.level))},fastExplosions:!1,setFastExplosions:function(t){this.fastExplosions=t,Explosion.fastExplosions=t},noExplosions:!1,setNoExplosions:function(t){this.noExplosions=t,Explosion.prototype.visible=!t},fastBeams:!1,setFastBeams:function(t){this.fastBeams=t,Beam.fastBeams=t},speed:1,setSpeed:function(t){this.speed=t,this.canvas.speed=t,this.level.bg.fillOpacity=this.motionBlur?1-Math.pow(1-this.level.bgOpacity,this.speed):1},motionBlur:!0,setMotionBlur:function(t){this.motionBlur=t,this.level.bg.fillOpacity=this.motionBlur?1-Math.pow(1-this.level.bgOpacity,this.speed):1},setupEtc:function(){this.canvas.updateFps=!0;var t=E("div"),e=-1,i=E.canvas(200,10),a=T(""),n=T(""),s=T(""),r=T("");t.append(a," fps (",n," ms to draw scene)",E("br"),s," real fps (",r," ms between frames)",E("br"),i);var h=i.getContext("2d");h.globalCompositeOperation="copy",h.fillStyle="#828292",this.canvas.addFrameListener(function(o){if(this.updateFps&&(h.drawImage(i,-1,0),h.clearRect(199,0,1,10),h.fillRect(199,0,1,Math.min(100,this.currentRealFps)/3.3),Math.floor(o/500)!=e)){e=Math.floor(o/500);var l=Math.floor(this.fps*10)/10,f=Math.floor(1e3/this.fps),u=Math.floor(this.realFps*10)/10,c=Math.floor(1e3/this.realFps);a.textContent=l,n.textContent=f,s.textContent=u,r.textContent=c}}),this.canvasControlPanel=new GuiConfig({object:this.canvas,container:$("debug"),title:"Debug",controls:["updateFps","playOnlyWhenFocused","drawBoundingBoxes",["useMockContext","boolean",{title:"Turn off drawing. Useful for benchmarking the AI."}]]}),this.canvasControlPanel.show(),this.controlPanel=new GuiConfig({object:this,container:$("debug"),title:"Graphics",controls:[["speed","0.1..1.0"],"motionBlur","fastExplosions","noExplosions","fastBeams"]}),this.controlPanel.show(),this.playerControlPanel=new GuiConfig({object:Player$1,container:$("debug"),title:"Support AI",controls:[["useMovementAI","boolean",{title:"Use movement AI"}],["useTargettingAI","boolean",{title:"Use targetting AI"}]]}),this.playerControlPanel.show(),$("debug").appendChild(t)}}),init=function(){var t=E.canvas(innerWidth*devicePixelRatio,innerHeight*devicePixelRatio),e=E("div",{id:"screen"});e.appendChild(t),document.body.appendChild(e),new MissileFleet(t),TouchControls.init(t),FullscreenMode.init(t)};init();"serviceWorker"in navigator&&navigator.serviceWorker.register("./sw.js",{updateViaCache:"none"}).then(t=>{console.log("Service Worker registered with scope:",t.scope)}).catch(t=>{console.log("Service Worker registration failed:",t)});
